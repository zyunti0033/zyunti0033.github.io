<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="RocketMQ-1, JAVA,Linux等...">
    <meta name="description" content="总结学习经验，记录生活点滴">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>RocketMQ-1 | Siri Zhang</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/css/my.css">

    <script src="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Siri Zhang" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


 

   <style>
    body{
       background-image: url(https://w.wallhaven.cc/full/3z/wallhaven-3zqdjv.jpg);
       background-repeat:no-repeat;
       background-size:cover;
       background-attachment:fixed;
    }
</style>



<body>

    

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Siri Zhang</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/navigate" class="waves-effect waves-light">
      
      <i class="fas fa-location-arrow" style="zoom: 0.6;"></i>
      
      <span>导航</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Siri Zhang</div>
        <div class="logo-desc">
            
            总结学习经验，记录生活点滴
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/navigate" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-location-arrow"></i>
			
			导航
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/zyunti0033" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/zyunti0033" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://ucc.alicdn.com/pic/developer-ecology/8a4242c472dd4f669ff5ad3d4095468e.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">RocketMQ-1</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/">
                                <span class="chip bg-color">消息中间件</span>
                            </a>
                        
                            <a href="/tags/RocketMQ/">
                                <span class="chip bg-color">RocketMQ</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/JAVA/" class="post-category">
                                JAVA
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-06-04
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2021-06-04
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    11.5k
                </div>
                

                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="1-MQ介绍"><a href="#1-MQ介绍" class="headerlink" title="1. MQ介绍"></a>1. MQ介绍</h1><p>##1.1为什么要用MQ</p>
<p>消息队列是一种“先进先出”的数据结构</p>
<p><img src="/2021/06/04/RocketMQ-1/queue1.png" alt="queue1.png"></p>
<p>其应用场景主要包含以下3个方面</p>
<ul>
<li>应用解耦</li>
</ul>
<p>系统的耦合性越高，容错性就越低。以电商应用为例，用户创建订单后，如果耦合调用库存系统、物流系统、支付系统，任何一个子系统出了故障或者因为升级等原因暂时不可用，都会造成下单操作异常，影响用户使用体验。</p>
<p><img src="/2021/06/04/RocketMQ-1/%E8%A7%A3%E8%80%A61.png" alt="解耦1.png"></p>
<p>使用消息队列解耦合，系统的耦合性就会提高了。比如物流系统发生故障，需要几分钟才能来修复，在这段时间内，物流系统要处理的数据被缓存到消息队列中，用户的下单操作正常完成。当物流系统回复后，补充处理存在消息队列中的订单消息即可，终端系统感知不到物流系统发生过几分钟故障。</p>
<p><img src="/2021/06/04/RocketMQ-1/%E8%A7%A3%E8%80%A62.png" alt="解耦2.png"></p>
<ul>
<li>流量削峰</li>
</ul>
<p><img src="/2021/06/04/RocketMQ-1/mq-5.png" alt="mq-5.png"></p>
<p>应用系统如果遇到系统请求流量的瞬间猛增，有可能会将系统压垮。有了消息队列可以将大量请求缓存起来，分散到很长一段时间处理，这样可以大大提到系统的稳定性和用户体验。</p>
<p><img src="/2021/06/04/RocketMQ-1/mq-6.png" alt="mq-6.png"></p>
<p>一般情况，为了保证系统的稳定性，如果系统负载超过阈值，就会阻止用户请求，这会影响用户体验，而如果使用消息队列将请求缓存起来，等待系统处理完毕后通知用户下单完毕，这样总不能下单体验要好。</p>
<p><u>处于经济考量目的：</u></p>
<p>业务系统正常时段的QPS如果是1000，流量最高峰是10000，为了应对流量高峰配置高性能的服务器显然不划算，这时可以使用消息队列对峰值流量削峰</p>
<ul>
<li>数据分发</li>
</ul>
<p><img src="/2021/06/04/RocketMQ-1/mq-1.png" alt="mq-1.png"></p>
<p>通过消息队列可以让数据在多个系统更加之间进行流通。数据的产生方不需要关心谁来使用数据，只需要将数据发送到消息队列，数据使用方直接在消息队列中直接获取数据即可</p>
<p><img src="/2021/06/04/RocketMQ-1/mq-2.png" alt="mq-2.png"></p>
<h2 id="1-2-MQ的优点和缺点"><a href="#1-2-MQ的优点和缺点" class="headerlink" title="1.2 MQ的优点和缺点"></a>1.2 MQ的优点和缺点</h2><p>优点：解耦、削峰、数据分发</p>
<p>缺点包含以下几点：</p>
<ul>
<li><p>系统可用性降低</p>
<p>系统引入的外部依赖越多，系统稳定性越差。一旦MQ宕机，就会对业务造成影响。</p>
<p>如何保证MQ的高可用？</p>
</li>
<li><p>系统复杂度提高</p>
<p>MQ的加入大大增加了系统的复杂度，以前系统间是同步的远程调用，现在是通过MQ进行异步调用。</p>
<p>如何保证消息没有被重复消费？怎么处理消息丢失情况？那么保证消息传递的顺序性？</p>
</li>
<li><p>一致性问题</p>
<p>A系统处理完业务，通过MQ给B、C、D三个系统发消息数据，如果B系统、C系统处理成功，D系统处理失败。</p>
<p>如何保证消息数据处理的一致性？</p>
</li>
</ul>
<h2 id="1-3-各种MQ产品的比较"><a href="#1-3-各种MQ产品的比较" class="headerlink" title="1.3 各种MQ产品的比较"></a>1.3 各种MQ产品的比较</h2><p>常见的MQ产品包括Kafka、ActiveMQ、RabbitMQ、RocketMQ。 </p>
<p><img src="/2021/06/04/RocketMQ-1/MQ%E6%AF%94%E8%BE%83.png"></p>
<h1 id="2-RocketMQ快速入门"><a href="#2-RocketMQ快速入门" class="headerlink" title="2. RocketMQ快速入门"></a>2. RocketMQ快速入门</h1><p>RocketMQ是阿里巴巴2016年MQ中间件，使用Java语言开发，在阿里内部，RocketMQ承接了例如“双11”等高并发场景的消息流转，能够处理万亿级别的消息。</p>
<h2 id="2-1-准备工作"><a href="#2-1-准备工作" class="headerlink" title="2.1 准备工作"></a>2.1 准备工作</h2><h3 id="2-1-1-下载RocketMQ"><a href="#2-1-1-下载RocketMQ" class="headerlink" title="2.1.1 下载RocketMQ"></a>2.1.1 下载RocketMQ</h3><p>RocketMQ最新版本：4.5.1</p>
<p><a target="_blank" rel="noopener" href="https://www.apache.org/dyn/closer.cgi?path=rocketmq/4.5.1/rocketmq-all-4.5.1-bin-release.zip">下载地址</a></p>
<h3 id="2-2-2-环境要求"><a href="#2-2-2-环境要求" class="headerlink" title="2.2.2 环境要求"></a>2.2.2 环境要求</h3><ul>
<li><p>Linux64位系统</p>
</li>
<li><p>JDK1.8(64位)</p>
</li>
<li><p>源码安装需要安装Maven 3.2.x</p>
</li>
</ul>
<h2 id="2-2-安装RocketMQ"><a href="#2-2-安装RocketMQ" class="headerlink" title="2.2 安装RocketMQ"></a>2.2 安装RocketMQ</h2><h3 id="2-2-1-安装步骤"><a href="#2-2-1-安装步骤" class="headerlink" title="2.2.1 安装步骤"></a>2.2.1 安装步骤</h3><p>本教程以二进制包方式安装</p>
<ol>
<li>解压安装包</li>
<li>进入安装目录</li>
</ol>
<h3 id="2-2-2-目录介绍"><a href="#2-2-2-目录介绍" class="headerlink" title="2.2.2 目录介绍"></a>2.2.2 目录介绍</h3><ul>
<li>bin：启动脚本，包括shell脚本和CMD脚本</li>
<li>conf：实例配置文件 ，包括broker配置文件、logback配置文件等</li>
<li>lib：依赖jar包，包括Netty、commons-lang、FastJSON等</li>
</ul>
<h2 id="2-3-启动RocketMQ"><a href="#2-3-启动RocketMQ" class="headerlink" title="2.3 启动RocketMQ"></a>2.3 启动RocketMQ</h2><ol>
<li>启动NameServer</li>
</ol>
<pre class=" language-shell"><code class="language-shell"># 1.启动NameServer
nohup sh bin/mqnamesrv &
# 2.查看启动日志
tail -f ~/logs/rocketmqlogs/namesrv.log
</code></pre>
<ol start="2">
<li>启动Broker</li>
</ol>
<pre class=" language-shell"><code class="language-shell"># 1.启动Broker
nohup sh bin/mqbroker -n localhost:9876 &
# 2.查看启动日志
tail -f ~/logs/rocketmqlogs/broker.log 
</code></pre>
<ul>
<li><p>问题描述：</p>
<p>RocketMQ默认的虚拟机内存较大，启动Broker如果因为内存不足失败，需要编辑如下两个配置文件，修改JVM内存大小</p>
</li>
</ul>
<pre class=" language-shell"><code class="language-shell"># 编辑runbroker.sh和runserver.sh修改默认JVM大小
vi runbroker.sh
vi runserver.sh
</code></pre>
<ul>
<li>参考设置：</li>
</ul>
<p><code>JAVA_OPT="${JAVA_OPT} -server -Xms256m -Xmx256m -Xmn128m -XX:MetaspaceSize=128m  -XX:MaxMetaspaceSize=320m"</code></p>
<h2 id="2-4-测试RocketMQ"><a href="#2-4-测试RocketMQ" class="headerlink" title="2.4 测试RocketMQ"></a>2.4 测试RocketMQ</h2><h3 id="2-4-1-发送消息"><a href="#2-4-1-发送消息" class="headerlink" title="2.4.1 发送消息"></a>2.4.1 发送消息</h3><pre class=" language-sh"><code class="language-sh"># 1.设置环境变量
export NAMESRV_ADDR=localhost:9876
# 2.使用安装包的Demo发送消息
sh bin/tools.sh org.apache.rocketmq.example.quickstart.Producer
</code></pre>
<h3 id="2-4-2-接收消息"><a href="#2-4-2-接收消息" class="headerlink" title="2.4.2 接收消息"></a>2.4.2 接收消息</h3><pre class=" language-shell"><code class="language-shell"># 1.设置环境变量
export NAMESRV_ADDR=localhost:9876
# 2.接收消息
sh bin/tools.sh org.apache.rocketmq.example.quickstart.Consumer
</code></pre>
<h2 id="2-5-关闭RocketMQ"><a href="#2-5-关闭RocketMQ" class="headerlink" title="2.5 关闭RocketMQ"></a>2.5 关闭RocketMQ</h2><pre class=" language-shell"><code class="language-shell"># 1.关闭NameServer
sh bin/mqshutdown namesrv
# 2.关闭Broker
sh bin/mqshutdown broker
</code></pre>
<h1 id="3-RocketMQ集群搭建"><a href="#3-RocketMQ集群搭建" class="headerlink" title="3. RocketMQ集群搭建"></a>3. RocketMQ集群搭建</h1><h2 id="3-1-各角色介绍"><a href="#3-1-各角色介绍" class="headerlink" title="3.1 各角色介绍"></a>3.1 各角色介绍</h2><ul>
<li>Producer：消息的发送者；举例：发信者</li>
<li>Consumer：消息接收者；举例：收信者</li>
<li>Broker：暂存和传输消息；举例：邮局</li>
<li>NameServer：管理Broker；举例：各个邮局的管理机构</li>
<li>Topic：区分消息的种类；一个发送者可以发送消息给一个或者多个Topic；一个消息的接收者可以订阅一个或者多个Topic消息</li>
<li>Message Queue：相当于是Topic的分区；用于并行发送和接收消息</li>
</ul>
<p><img src="/2021/06/04/RocketMQ-1/RocketMQ%E8%A7%92%E8%89%B2.jpg" alt="RocketMQ角色.jpg"></p>
<h2 id="3-2-集群搭建方式"><a href="#3-2-集群搭建方式" class="headerlink" title="3.2 集群搭建方式"></a>3.2 集群搭建方式</h2><h3 id="3-2-1-集群特点"><a href="#3-2-1-集群特点" class="headerlink" title="3.2.1 集群特点"></a>3.2.1 集群特点</h3><ul>
<li><p>NameServer是一个几乎无状态节点，可集群部署，节点之间无任何信息同步。</p>
</li>
<li><p>Broker部署相对复杂，Broker分为Master与Slave，一个Master可以对应多个Slave，但是一个Slave只能对应一个Master，Master与Slave的对应关系通过指定相同的BrokerName，不同的BrokerId来定义，BrokerId为0表示Master，非0表示Slave。Master也可以部署多个。每个Broker与NameServer集群中的所有节点建立长连接，定时注册Topic信息到所有NameServer。</p>
</li>
<li><p>Producer与NameServer集群中的其中一个节点（随机选择）建立长连接，定期从NameServer取Topic路由信息，并向提供Topic服务的Master建立长连接，且定时向Master发送心跳。Producer完全无状态，可集群部署。</p>
</li>
<li><p>Consumer与NameServer集群中的其中一个节点（随机选择）建立长连接，定期从NameServer取Topic路由信息，并向提供Topic服务的Master、Slave建立长连接，且定时向Master、Slave发送心跳。Consumer既可以从Master订阅消息，也可以从Slave订阅消息，订阅规则由Broker配置决定。</p>
</li>
</ul>
<h3 id="3-2-3-集群模式"><a href="#3-2-3-集群模式" class="headerlink" title="3.2.3 集群模式"></a>3.2.3 集群模式</h3><h4 id="1）单Master模式"><a href="#1）单Master模式" class="headerlink" title="1）单Master模式"></a>1）单Master模式</h4><p>这种方式风险较大，一旦Broker重启或者宕机时，会导致整个服务不可用。不建议线上环境使用,可以用于本地测试。</p>
<h4 id="2）多Master模式"><a href="#2）多Master模式" class="headerlink" title="2）多Master模式"></a>2）多Master模式</h4><p>一个集群无Slave，全是Master，例如2个Master或者3个Master，这种模式的优缺点如下：</p>
<ul>
<li>优点：配置简单，单个Master宕机或重启维护对应用无影响，在磁盘配置为RAID10时，即使机器宕机不可恢复情况下，由于RAID10磁盘非常可靠，消息也不会丢（异步刷盘丢失少量消息，同步刷盘一条不丢），性能最高；</li>
<li>缺点：单台机器宕机期间，这台机器上未被消费的消息在机器恢复之前不可订阅，消息实时性会受到影响。</li>
</ul>
<h4 id="3）多Master多Slave模式（异步）"><a href="#3）多Master多Slave模式（异步）" class="headerlink" title="3）多Master多Slave模式（异步）"></a>3）多Master多Slave模式（异步）</h4><p>每个Master配置一个Slave，有多对Master-Slave，HA采用异步复制方式，主备有短暂消息延迟（毫秒级），这种模式的优缺点如下：</p>
<ul>
<li>优点：即使磁盘损坏，消息丢失的非常少，且消息实时性不会受影响，同时Master宕机后，消费者仍然可以从Slave消费，而且此过程对应用透明，不需要人工干预，性能同多Master模式几乎一样；</li>
<li>缺点：Master宕机，磁盘损坏情况下会丢失少量消息。</li>
</ul>
<h4 id="4）多Master多Slave模式（同步）"><a href="#4）多Master多Slave模式（同步）" class="headerlink" title="4）多Master多Slave模式（同步）"></a>4）多Master多Slave模式（同步）</h4><p>每个Master配置一个Slave，有多对Master-Slave，HA采用同步双写方式，即只有主备都写成功，才向应用返回成功，这种模式的优缺点如下：</p>
<ul>
<li>优点：数据与服务都无单点故障，Master宕机情况下，消息无延迟，服务可用性与数据可用性都非常高；</li>
<li>缺点：性能比异步复制模式略低（大约低10%左右），发送单个消息的RT会略高，且目前版本在主节点宕机后，备机不能自动切换为主机。</li>
</ul>
<h2 id="3-3-双主双从集群搭建"><a href="#3-3-双主双从集群搭建" class="headerlink" title="3.3 双主双从集群搭建"></a>3.3 双主双从集群搭建</h2><h3 id="3-3-1-总体架构"><a href="#3-3-1-总体架构" class="headerlink" title="3.3.1 总体架构"></a>3.3.1 总体架构</h3><p>消息高可用采用2m-2s（同步双写）方式</p>
<p><img src="/2021/06/04/RocketMQ-1/RocketMQ%E9%9B%86%E7%BE%A4.png" alt="RocketMQ集群.png"></p>
<h3 id="3-3-2-集群工作流程"><a href="#3-3-2-集群工作流程" class="headerlink" title="3.3.2 集群工作流程"></a>3.3.2 集群工作流程</h3><ol>
<li>启动NameServer，NameServer起来后监听端口，等待Broker、Producer、Consumer连上来，相当于一个路由控制中心。</li>
<li>Broker启动，跟所有的NameServer保持长连接，定时发送心跳包。心跳包中包含当前Broker信息(IP+端口等)以及存储所有Topic信息。注册成功后，NameServer集群中就有Topic跟Broker的映射关系。</li>
<li>收发消息前，先创建Topic，创建Topic时需要指定该Topic要存储在哪些Broker上，也可以在发送消息时自动创建Topic。</li>
<li>Producer发送消息，启动时先跟NameServer集群中的其中一台建立长连接，并从NameServer中获取当前发送的Topic存在哪些Broker上，轮询从队列列表中选择一个队列，然后与队列所在的Broker建立长连接从而向Broker发消息。</li>
<li>Consumer跟Producer类似，跟其中一台NameServer建立长连接，获取当前订阅Topic存在哪些Broker上，然后直接跟Broker建立连接通道，开始消费消息。</li>
</ol>
<h3 id="3-3-3-服务器环境"><a href="#3-3-3-服务器环境" class="headerlink" title="3.3.3 服务器环境"></a>3.3.3 服务器环境</h3><table>
<thead>
<tr>
<th><strong>序号</strong></th>
<th><strong>IP</strong></th>
<th><strong>角色</strong></th>
<th><strong>架构模式</strong></th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>192.168.25.135</td>
<td>nameserver、brokerserver</td>
<td>Master1、Slave2</td>
</tr>
<tr>
<td>2</td>
<td>192.168.25.138</td>
<td>nameserver、brokerserver</td>
<td>Master2、Slave1</td>
</tr>
</tbody></table>
<h3 id="3-3-4-Host添加信息"><a href="#3-3-4-Host添加信息" class="headerlink" title="3.3.4 Host添加信息"></a>3.3.4 Host添加信息</h3><pre class=" language-bash"><code class="language-bash">vim /etc/hosts
</code></pre>
<p>配置如下:</p>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># nameserver</span>
192.168.25.135 rocketmq-nameserver1
192.168.25.138 rocketmq-nameserver2
<span class="token comment" spellcheck="true"># broker</span>
192.168.25.135 rocketmq-master1
192.168.25.135 rocketmq-slave2
192.168.25.138 rocketmq-master2
192.168.25.138 rocketmq-slave1
</code></pre>
<p>配置完成后, 重启网卡</p>
<pre class=" language-bash"><code class="language-bash">systemctl restart network
</code></pre>
<h3 id="3-3-5-防火墙配置"><a href="#3-3-5-防火墙配置" class="headerlink" title="3.3.5 防火墙配置"></a>3.3.5 防火墙配置</h3><p>宿主机需要远程访问虚拟机的rocketmq服务和web服务，需要开放相关的端口号，简单粗暴的方式是直接关闭防火墙</p>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 关闭防火墙</span>
systemctl stop firewalld.service 
<span class="token comment" spellcheck="true"># 查看防火墙的状态</span>
firewall-cmd --state 
<span class="token comment" spellcheck="true"># 禁止firewall开机启动</span>
systemctl disable firewalld.service
</code></pre>
<p>或者为了安全，只开放特定的端口号，RocketMQ默认使用3个端口：9876 、10911 、11011 。如果防火墙没有关闭的话，那么防火墙就必须开放这些端口：</p>
<ul>
<li><code>nameserver</code> 默认使用 9876 端口</li>
<li><code>master</code> 默认使用 10911 端口</li>
<li><code>slave</code> 默认使用11011 端口</li>
</ul>
<p>执行以下命令：</p>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 开放name server默认端口</span>
firewall-cmd --remove-port<span class="token operator">=</span>9876/tcp --permanent
<span class="token comment" spellcheck="true"># 开放master默认端口</span>
firewall-cmd --remove-port<span class="token operator">=</span>10911/tcp --permanent
<span class="token comment" spellcheck="true"># 开放slave默认端口 (当前集群模式可不开启)</span>
firewall-cmd --remove-port<span class="token operator">=</span>11011/tcp --permanent 
<span class="token comment" spellcheck="true"># 重启防火墙</span>
firewall-cmd --reload
</code></pre>
<h3 id="3-3-6-环境变量配置"><a href="#3-3-6-环境变量配置" class="headerlink" title="3.3.6 环境变量配置"></a>3.3.6 环境变量配置</h3><pre class=" language-bash"><code class="language-bash">vim /etc/profile
</code></pre>
<p>在profile文件的末尾加入如下命令</p>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#set rocketmq</span>
ROCKETMQ_HOME<span class="token operator">=</span>/usr/local/rocketmq/rocketmq-all-4.4.0-bin-release
PATH<span class="token operator">=</span><span class="token variable">$PATH</span><span class="token keyword">:</span><span class="token variable">$ROCKETMQ_HOME</span>/bin
<span class="token function">export</span> ROCKETMQ_HOME PATH
</code></pre>
<p>输入:wq! 保存并退出， 并使得配置立刻生效：</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">source</span> /etc/profile
</code></pre>
<h3 id="3-3-7-创建消息存储路径"><a href="#3-3-7-创建消息存储路径" class="headerlink" title="3.3.7 创建消息存储路径"></a>3.3.7 创建消息存储路径</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">mkdir</span> /usr/local/rocketmq/store
<span class="token function">mkdir</span> /usr/local/rocketmq/store/commitlog
<span class="token function">mkdir</span> /usr/local/rocketmq/store/consumequeue
<span class="token function">mkdir</span> /usr/local/rocketmq/store/index
</code></pre>
<h3 id="3-3-8-broker配置文件"><a href="#3-3-8-broker配置文件" class="headerlink" title="3.3.8 broker配置文件"></a>3.3.8 broker配置文件</h3><h4 id="1）master1"><a href="#1）master1" class="headerlink" title="1）master1"></a>1）master1</h4><p>服务器：192.168.25.135</p>
<pre class=" language-sh"><code class="language-sh">vi /usr/soft/rocketmq/conf/2m-2s-sync/broker-a.properties
</code></pre>
<p>修改配置如下：</p>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#所属集群名字</span>
brokerClusterName<span class="token operator">=</span>rocketmq-cluster
<span class="token comment" spellcheck="true">#broker名字，注意此处不同的配置文件填写的不一样</span>
brokerName<span class="token operator">=</span>broker-a
<span class="token comment" spellcheck="true">#0 表示 Master，>0 表示 Slave</span>
brokerId<span class="token operator">=</span>0
<span class="token comment" spellcheck="true">#nameServer地址，分号分割</span>
namesrvAddr<span class="token operator">=</span>rocketmq-nameserver1:9876<span class="token punctuation">;</span>rocketmq-nameserver2:9876
<span class="token comment" spellcheck="true">#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span>
defaultTopicQueueNums<span class="token operator">=</span>4
<span class="token comment" spellcheck="true">#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭</span>
autoCreateTopicEnable<span class="token operator">=</span>true
<span class="token comment" spellcheck="true">#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭</span>
autoCreateSubscriptionGroup<span class="token operator">=</span>true
<span class="token comment" spellcheck="true">#Broker 对外服务的监听端口</span>
listenPort<span class="token operator">=</span>10911
<span class="token comment" spellcheck="true">#删除文件时间点，默认凌晨 4点</span>
deleteWhen<span class="token operator">=</span>04
<span class="token comment" spellcheck="true">#文件保留时间，默认 48 小时</span>
fileReservedTime<span class="token operator">=</span>120
<span class="token comment" spellcheck="true">#commitLog每个文件的大小默认1G</span>
mapedFileSizeCommitLog<span class="token operator">=</span>1073741824
<span class="token comment" spellcheck="true">#ConsumeQueue每个文件默认存30W条，根据业务情况调整</span>
mapedFileSizeConsumeQueue<span class="token operator">=</span>300000
<span class="token comment" spellcheck="true">#destroyMapedFileIntervalForcibly=120000</span>
<span class="token comment" spellcheck="true">#redeleteHangedFileInterval=120000</span>
<span class="token comment" spellcheck="true">#检测物理文件磁盘空间</span>
diskMaxUsedSpaceRatio<span class="token operator">=</span>88
<span class="token comment" spellcheck="true">#存储路径</span>
storePathRootDir<span class="token operator">=</span>/usr/local/rocketmq/store
<span class="token comment" spellcheck="true">#commitLog 存储路径</span>
storePathCommitLog<span class="token operator">=</span>/usr/local/rocketmq/store/commitlog
<span class="token comment" spellcheck="true">#消费队列存储路径存储路径</span>
storePathConsumeQueue<span class="token operator">=</span>/usr/local/rocketmq/store/consumequeue
<span class="token comment" spellcheck="true">#消息索引存储路径</span>
storePathIndex<span class="token operator">=</span>/usr/local/rocketmq/store/index
<span class="token comment" spellcheck="true">#checkpoint 文件存储路径</span>
storeCheckpoint<span class="token operator">=</span>/usr/local/rocketmq/store/checkpoint
<span class="token comment" spellcheck="true">#abort 文件存储路径</span>
abortFile<span class="token operator">=</span>/usr/local/rocketmq/store/abort
<span class="token comment" spellcheck="true">#限制的消息大小</span>
maxMessageSize<span class="token operator">=</span>65536
<span class="token comment" spellcheck="true">#flushCommitLogLeastPages=4</span>
<span class="token comment" spellcheck="true">#flushConsumeQueueLeastPages=2</span>
<span class="token comment" spellcheck="true">#flushCommitLogThoroughInterval=10000</span>
<span class="token comment" spellcheck="true">#flushConsumeQueueThoroughInterval=60000</span>
<span class="token comment" spellcheck="true">#Broker 的角色</span>
<span class="token comment" spellcheck="true">#- ASYNC_MASTER 异步复制Master</span>
<span class="token comment" spellcheck="true">#- SYNC_MASTER 同步双写Master</span>
<span class="token comment" spellcheck="true">#- SLAVE</span>
brokerRole<span class="token operator">=</span>SYNC_MASTER
<span class="token comment" spellcheck="true">#刷盘方式</span>
<span class="token comment" spellcheck="true">#- ASYNC_FLUSH 异步刷盘</span>
<span class="token comment" spellcheck="true">#- SYNC_FLUSH 同步刷盘</span>
flushDiskType<span class="token operator">=</span>SYNC_FLUSH
<span class="token comment" spellcheck="true">#checkTransactionMessageEnable=false</span>
<span class="token comment" spellcheck="true">#发消息线程池数量</span>
<span class="token comment" spellcheck="true">#sendMessageThreadPoolNums=128</span>
<span class="token comment" spellcheck="true">#拉消息线程池数量</span>
<span class="token comment" spellcheck="true">#pullMessageThreadPoolNums=128</span>
</code></pre>
<h4 id="2）slave2"><a href="#2）slave2" class="headerlink" title="2）slave2"></a>2）slave2</h4><p>服务器：192.168.25.135</p>
<pre class=" language-sh"><code class="language-sh">vi /usr/soft/rocketmq/conf/2m-2s-sync/broker-b-s.properties
</code></pre>
<p>修改配置如下：</p>
<pre class=" language-bash"><code class="language-bash">
</code></pre>
<h4 id="3）master2"><a href="#3）master2" class="headerlink" title="3）master2"></a>3）master2</h4><p>服务器：192.168.25.138</p>
<pre class=" language-sh"><code class="language-sh">vi /usr/soft/rocketmq/conf/2m-2s-sync/broker-b.properties
</code></pre>
<p>修改配置如下：</p>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#所属集群名字</span>
brokerClusterName<span class="token operator">=</span>rocketmq-cluster
<span class="token comment" spellcheck="true">#broker名字，注意此处不同的配置文件填写的不一样</span>
brokerName<span class="token operator">=</span>broker-b
<span class="token comment" spellcheck="true">#0 表示 Master，>0 表示 Slave</span>
brokerId<span class="token operator">=</span>0
<span class="token comment" spellcheck="true">#nameServer地址，分号分割</span>
namesrvAddr<span class="token operator">=</span>rocketmq-nameserver1:9876<span class="token punctuation">;</span>rocketmq-nameserver2:9876
<span class="token comment" spellcheck="true">#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span>
defaultTopicQueueNums<span class="token operator">=</span>4
<span class="token comment" spellcheck="true">#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭</span>
autoCreateTopicEnable<span class="token operator">=</span>true
<span class="token comment" spellcheck="true">#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭</span>
autoCreateSubscriptionGroup<span class="token operator">=</span>true
<span class="token comment" spellcheck="true">#Broker 对外服务的监听端口</span>
listenPort<span class="token operator">=</span>10911
<span class="token comment" spellcheck="true">#删除文件时间点，默认凌晨 4点</span>
deleteWhen<span class="token operator">=</span>04
<span class="token comment" spellcheck="true">#文件保留时间，默认 48 小时</span>
fileReservedTime<span class="token operator">=</span>120
<span class="token comment" spellcheck="true">#commitLog每个文件的大小默认1G</span>
mapedFileSizeCommitLog<span class="token operator">=</span>1073741824
<span class="token comment" spellcheck="true">#ConsumeQueue每个文件默认存30W条，根据业务情况调整</span>
mapedFileSizeConsumeQueue<span class="token operator">=</span>300000
<span class="token comment" spellcheck="true">#destroyMapedFileIntervalForcibly=120000</span>
<span class="token comment" spellcheck="true">#redeleteHangedFileInterval=120000</span>
<span class="token comment" spellcheck="true">#检测物理文件磁盘空间</span>
diskMaxUsedSpaceRatio<span class="token operator">=</span>88
<span class="token comment" spellcheck="true">#存储路径</span>
storePathRootDir<span class="token operator">=</span>/usr/local/rocketmq/store
<span class="token comment" spellcheck="true">#commitLog 存储路径</span>
storePathCommitLog<span class="token operator">=</span>/usr/local/rocketmq/store/commitlog
<span class="token comment" spellcheck="true">#消费队列存储路径存储路径</span>
storePathConsumeQueue<span class="token operator">=</span>/usr/local/rocketmq/store/consumequeue
<span class="token comment" spellcheck="true">#消息索引存储路径</span>
storePathIndex<span class="token operator">=</span>/usr/local/rocketmq/store/index
<span class="token comment" spellcheck="true">#checkpoint 文件存储路径</span>
storeCheckpoint<span class="token operator">=</span>/usr/local/rocketmq/store/checkpoint
<span class="token comment" spellcheck="true">#abort 文件存储路径</span>
abortFile<span class="token operator">=</span>/usr/local/rocketmq/store/abort
<span class="token comment" spellcheck="true">#限制的消息大小</span>
maxMessageSize<span class="token operator">=</span>65536
<span class="token comment" spellcheck="true">#flushCommitLogLeastPages=4</span>
<span class="token comment" spellcheck="true">#flushConsumeQueueLeastPages=2</span>
<span class="token comment" spellcheck="true">#flushCommitLogThoroughInterval=10000</span>
<span class="token comment" spellcheck="true">#flushConsumeQueueThoroughInterval=60000</span>
<span class="token comment" spellcheck="true">#Broker 的角色</span>
<span class="token comment" spellcheck="true">#- ASYNC_MASTER 异步复制Master</span>
<span class="token comment" spellcheck="true">#- SYNC_MASTER 同步双写Master</span>
<span class="token comment" spellcheck="true">#- SLAVE</span>
brokerRole<span class="token operator">=</span>SYNC_MASTER
<span class="token comment" spellcheck="true">#刷盘方式</span>
<span class="token comment" spellcheck="true">#- ASYNC_FLUSH 异步刷盘</span>
<span class="token comment" spellcheck="true">#- SYNC_FLUSH 同步刷盘</span>
flushDiskType<span class="token operator">=</span>SYNC_FLUSH
<span class="token comment" spellcheck="true">#checkTransactionMessageEnable=false</span>
<span class="token comment" spellcheck="true">#发消息线程池数量</span>
<span class="token comment" spellcheck="true">#sendMessageThreadPoolNums=128</span>
<span class="token comment" spellcheck="true">#拉消息线程池数量</span>
<span class="token comment" spellcheck="true">#pullMessageThreadPoolNums=128</span>
</code></pre>
<h4 id="4）slave1"><a href="#4）slave1" class="headerlink" title="4）slave1"></a>4）slave1</h4><p>服务器：192.168.25.138</p>
<pre class=" language-sh"><code class="language-sh">vi /usr/soft/rocketmq/conf/2m-2s-sync/broker-a-s.properties
</code></pre>
<p>修改配置如下：</p>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#所属集群名字</span>
brokerClusterName<span class="token operator">=</span>rocketmq-cluster
<span class="token comment" spellcheck="true">#broker名字，注意此处不同的配置文件填写的不一样</span>
brokerName<span class="token operator">=</span>broker-a
<span class="token comment" spellcheck="true">#0 表示 Master，>0 表示 Slave</span>
brokerId<span class="token operator">=</span>1
<span class="token comment" spellcheck="true">#nameServer地址，分号分割</span>
namesrvAddr<span class="token operator">=</span>rocketmq-nameserver1:9876<span class="token punctuation">;</span>rocketmq-nameserver2:9876
<span class="token comment" spellcheck="true">#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span>
defaultTopicQueueNums<span class="token operator">=</span>4
<span class="token comment" spellcheck="true">#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭</span>
autoCreateTopicEnable<span class="token operator">=</span>true
<span class="token comment" spellcheck="true">#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭</span>
autoCreateSubscriptionGroup<span class="token operator">=</span>true
<span class="token comment" spellcheck="true">#Broker 对外服务的监听端口</span>
listenPort<span class="token operator">=</span>11011
<span class="token comment" spellcheck="true">#删除文件时间点，默认凌晨 4点</span>
deleteWhen<span class="token operator">=</span>04
<span class="token comment" spellcheck="true">#文件保留时间，默认 48 小时</span>
fileReservedTime<span class="token operator">=</span>120
<span class="token comment" spellcheck="true">#commitLog每个文件的大小默认1G</span>
mapedFileSizeCommitLog<span class="token operator">=</span>1073741824
<span class="token comment" spellcheck="true">#ConsumeQueue每个文件默认存30W条，根据业务情况调整</span>
mapedFileSizeConsumeQueue<span class="token operator">=</span>300000
<span class="token comment" spellcheck="true">#destroyMapedFileIntervalForcibly=120000</span>
<span class="token comment" spellcheck="true">#redeleteHangedFileInterval=120000</span>
<span class="token comment" spellcheck="true">#检测物理文件磁盘空间</span>
diskMaxUsedSpaceRatio<span class="token operator">=</span>88
<span class="token comment" spellcheck="true">#存储路径</span>
storePathRootDir<span class="token operator">=</span>/usr/local/rocketmq/store
<span class="token comment" spellcheck="true">#commitLog 存储路径</span>
storePathCommitLog<span class="token operator">=</span>/usr/local/rocketmq/store/commitlog
<span class="token comment" spellcheck="true">#消费队列存储路径存储路径</span>
storePathConsumeQueue<span class="token operator">=</span>/usr/local/rocketmq/store/consumequeue
<span class="token comment" spellcheck="true">#消息索引存储路径</span>
storePathIndex<span class="token operator">=</span>/usr/local/rocketmq/store/index
<span class="token comment" spellcheck="true">#checkpoint 文件存储路径</span>
storeCheckpoint<span class="token operator">=</span>/usr/local/rocketmq/store/checkpoint
<span class="token comment" spellcheck="true">#abort 文件存储路径</span>
abortFile<span class="token operator">=</span>/usr/local/rocketmq/store/abort
<span class="token comment" spellcheck="true">#限制的消息大小</span>
maxMessageSize<span class="token operator">=</span>65536
<span class="token comment" spellcheck="true">#flushCommitLogLeastPages=4</span>
<span class="token comment" spellcheck="true">#flushConsumeQueueLeastPages=2</span>
<span class="token comment" spellcheck="true">#flushCommitLogThoroughInterval=10000</span>
<span class="token comment" spellcheck="true">#flushConsumeQueueThoroughInterval=60000</span>
<span class="token comment" spellcheck="true">#Broker 的角色</span>
<span class="token comment" spellcheck="true">#- ASYNC_MASTER 异步复制Master</span>
<span class="token comment" spellcheck="true">#- SYNC_MASTER 同步双写Master</span>
<span class="token comment" spellcheck="true">#- SLAVE</span>
brokerRole<span class="token operator">=</span>SLAVE
<span class="token comment" spellcheck="true">#刷盘方式</span>
<span class="token comment" spellcheck="true">#- ASYNC_FLUSH 异步刷盘</span>
<span class="token comment" spellcheck="true">#- SYNC_FLUSH 同步刷盘</span>
flushDiskType<span class="token operator">=</span>ASYNC_FLUSH
<span class="token comment" spellcheck="true">#checkTransactionMessageEnable=false</span>
<span class="token comment" spellcheck="true">#发消息线程池数量</span>
<span class="token comment" spellcheck="true">#sendMessageThreadPoolNums=128</span>
<span class="token comment" spellcheck="true">#拉消息线程池数量</span>
<span class="token comment" spellcheck="true">#pullMessageThreadPoolNums=128</span>
</code></pre>
<h3 id="3-3-9-修改启动脚本文件"><a href="#3-3-9-修改启动脚本文件" class="headerlink" title="3.3.9 修改启动脚本文件"></a>3.3.9 修改启动脚本文件</h3><h4 id="1）runbroker-sh"><a href="#1）runbroker-sh" class="headerlink" title="1）runbroker.sh"></a>1）runbroker.sh</h4><pre class=" language-sh"><code class="language-sh">vi /usr/local/rocketmq/bin/runbroker.sh
</code></pre>
<p>需要根据内存大小进行适当的对JVM参数进行调整：</p>
<pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#===================================================</span>
<span class="token comment" spellcheck="true"># 开发环境配置 JVM Configuration</span>
JAVA_OPT<span class="token operator">=</span><span class="token string">"<span class="token variable">${JAVA_OPT}</span> -server -Xms256m -Xmx256m -Xmn128m"</span>
</code></pre>
<p>####2）runserver.sh</p>
<pre class=" language-sh"><code class="language-sh">vim /usr/local/rocketmq/bin/runserver.sh
</code></pre>
<pre class=" language-bash"><code class="language-bash">JAVA_OPT<span class="token operator">=</span><span class="token string">"<span class="token variable">${JAVA_OPT}</span> -server -Xms256m -Xmx256m -Xmn128m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m"</span>
</code></pre>
<h3 id="3-3-10-服务启动"><a href="#3-3-10-服务启动" class="headerlink" title="3.3.10 服务启动"></a>3.3.10 服务启动</h3><h4 id="1）启动NameServe集群"><a href="#1）启动NameServe集群" class="headerlink" title="1）启动NameServe集群"></a>1）启动NameServe集群</h4><p>分别在192.168.25.135和192.168.25.138启动NameServer</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">cd</span> /usr/local/rocketmq/bin
<span class="token function">nohup</span> sh mqnamesrv <span class="token operator">&amp;</span>
</code></pre>
<h4 id="2）启动Broker集群"><a href="#2）启动Broker集群" class="headerlink" title="2）启动Broker集群"></a>2）启动Broker集群</h4><ul>
<li>在192.168.25.135上启动master1和slave2</li>
</ul>
<p>master1：</p>
<pre class=" language-bash"><code class="language-bash"><span class="token function">cd</span> /usr/local/rocketmq/bin
<span class="token function">nohup</span> sh mqbroker -c /usr/local/rocketmq/conf/2m-2s-syncbroker-a.properties <span class="token operator">&amp;</span>
</code></pre>
<p>slave2：</p>
<pre class=" language-sh"><code class="language-sh">cd /usr/local/rocketmq/bin
nohup sh mqbroker -c /usr/local/rocketmq/conf/2m-2s-sync/broker-b-s.properties &
</code></pre>
<ul>
<li>在192.168.25.138上启动master2和slave2</li>
</ul>
<p>master2</p>
<pre class=" language-sh"><code class="language-sh">cd /usr/local/rocketmq/bin
nohup sh mqbroker -c /usr/local/rocketmq/conf/2m-2s-sync/broker-b.properties &
</code></pre>
<p>slave1</p>
<pre class=" language-sh"><code class="language-sh">cd /usr/local/rocketmq/bin
nohup sh mqbroker -c /usr/local/rocketmq/conf/2m-2s-sync/broker-a-s.properties &
</code></pre>
<h3 id="3-3-11-查看进程状态"><a href="#3-3-11-查看进程状态" class="headerlink" title="3.3.11 查看进程状态"></a>3.3.11 查看进程状态</h3><p>启动后通过JPS查看启动进程</p>
<p><img src="/2021/06/04/RocketMQ-1/jps1.png" alt="jps1.png"></p>
<h3 id="3-3-12-查看日志"><a href="#3-3-12-查看日志" class="headerlink" title="3.3.12 查看日志"></a>3.3.12 查看日志</h3><pre class=" language-sh"><code class="language-sh"># 查看nameServer日志
tail -500f ~/logs/rocketmqlogs/namesrv.log
# 查看broker日志
tail -500f ~/logs/rocketmqlogs/broker.log
</code></pre>
<h2 id="3-4-mqadmin管理工具"><a href="#3-4-mqadmin管理工具" class="headerlink" title="3.4 mqadmin管理工具"></a>3.4 mqadmin管理工具</h2><h3 id="3-4-1-使用方式"><a href="#3-4-1-使用方式" class="headerlink" title="3.4.1 使用方式"></a>3.4.1 使用方式</h3><p>进入RocketMQ安装位置，在bin目录下执行<code>./mqadmin {command} {args}</code> </p>
<p>###3.4.2 命令介绍</p>
<p>####1）Topic相关</p>
<table border="0" cellpadding="0" cellspacing="0" width="714">
 <colgroup><col width="177">
 <col width="175">
 <col width="177">
 <col width="185">
 </colgroup><tbody><tr height="23" style="height:17.0pt">
  <td height="23" class="xl63" width="177" style="height:17.0pt;width:133pt">名称</td>
  <td class="xl64" width="175" style="width:131pt">含义</td>
  <td class="xl64" width="177" style="width:133pt">命令选项</td>
  <td class="xl64" width="185" style="width:139pt">说明</td>
 </tr>
 <tr height="132" style="height:99.0pt">
  <td rowspan="8" height="593" class="xl68" width="163" style="border-bottom:1.0pt;
  height:444.0pt;border-top:none;width:122pt">updateTopic</td>
  <td rowspan="8" class="xl70" width="135" style="border-bottom:1.0pt;
  border-top:none;width:101pt">创建更新Topic配置</td>
  <td class="xl65" width="149" style="width:112pt">-b</td>
  <td class="xl66" width="159" style="width:119pt">Broker 地址，表示 topic 所在
  Broker，只支持单台Broker，地址为ip:port</td>
 </tr>
 <tr height="132" style="height:99.0pt">
  <td height="132" class="xl65" width="149" style="height:99.0pt;width:112pt">-c</td>
  <td class="xl66" width="159" style="width:119pt">cluster 名称，表示 topic 所在集群（集群可通过
  clusterList 查询）</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl65" width="149" style="height:17.0pt;width:112pt">-h-</td>
  <td class="xl66" width="159" style="width:119pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl65" width="149" style="height:43.0pt;width:112pt">-n</td>
  <td class="xl66" width="159" style="width:119pt">NameServer服务地址，格式 ip:port</td>
 </tr>
 <tr height="76" style="height:57.0pt">
  <td height="76" class="xl65" width="149" style="height:57.0pt;width:112pt">-p</td>
  <td class="xl66" width="159" style="width:119pt">指定新topic的读写权限( W=2|R=4|WR=6 )</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl65" width="149" style="height:29.0pt;width:112pt">-r</td>
  <td class="xl66" width="159" style="width:119pt">可读队列数（默认为 8）</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl65" width="149" style="height:29.0pt;width:112pt">-w</td>
  <td class="xl66" width="159" style="width:119pt">可写队列数（默认为 8）</td>
 </tr>
 <tr height="95" style="height:71.0pt">
  <td height="95" class="xl65" width="149" style="height:71.0pt;width:112pt">-t</td>
  <td class="xl66" width="159" style="width:119pt">topic 名称（名称只能使用字符
  ^[a-zA-Z0-9_-]+$ ）</td>
 </tr>
 <tr height="132" style="height:99.0pt">
  <td rowspan="4" height="307" class="xl68" width="163" style="border-bottom:1.0pt;
  height:230.0pt;border-top:none;width:122pt">deleteTopic</td>
  <td rowspan="4" class="xl70" width="135" style="border-bottom:1.0pt;
  border-top:none;width:101pt">删除Topic</td>
  <td class="xl65" width="149" style="width:112pt">-c</td>
  <td class="xl66" width="159" style="width:119pt">cluster 名称，表示删除某集群下的某个 topic （集群
  可通过 clusterList 查询）</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl65" width="149" style="height:17.0pt;width:112pt">-h</td>
  <td class="xl66" width="159" style="width:119pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl65" width="149" style="height:43.0pt;width:112pt">-n</td>
  <td class="xl66" width="159" style="width:119pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="95" style="height:71.0pt">
  <td height="95" class="xl65" width="149" style="height:71.0pt;width:112pt">-t</td>
  <td class="xl66" width="159" style="width:119pt">topic 名称（名称只能使用字符
  ^[a-zA-Z0-9_-]+$ ）</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="3" height="287" class="xl68" width="163" style="border-bottom:1.0pt;
  height:215.0pt;border-top:none;width:122pt">topicList</td>
  <td rowspan="3" class="xl70" width="135" style="border-bottom:1.0pt;
  border-top:none;width:101pt">查看 Topic 列表信息</td>
  <td class="xl65" width="149" style="width:112pt">-h</td>
  <td class="xl66" width="159" style="width:119pt">打印帮助</td>
 </tr>
 <tr height="207" style="height:155.0pt">
  <td height="207" class="xl65" width="149" style="height:155.0pt;width:112pt">-c</td>
  <td class="xl66" width="159" style="width:119pt">不配置-c只返回topic列表，增加-c返回clusterName,
  topic, consumerGroup信息，即topic的所属集群和订阅关系，没有参数</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl65" width="149" style="height:43.0pt;width:112pt">-n</td>
  <td class="xl66" width="159" style="width:119pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="3" height="103" class="xl68" width="163" style="border-bottom:1.0pt;
  height:77.0pt;border-top:none;width:122pt">topicRoute</td>
  <td rowspan="3" class="xl70" width="135" style="border-bottom:1.0pt;
  border-top:none;width:101pt">查看 Topic 路由信息</td>
  <td class="xl65" width="149" style="width:112pt">-t</td>
  <td class="xl66" width="159" style="width:119pt">topic 名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl65" width="149" style="height:17.0pt;width:112pt">-h</td>
  <td class="xl66" width="159" style="width:119pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl65" width="149" style="height:43.0pt;width:112pt">-n</td>
  <td class="xl66" width="159" style="width:119pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="3" height="103" class="xl68" width="163" style="border-bottom:1.0pt;
  height:77.0pt;border-top:none;width:122pt">topicStatus</td>
  <td rowspan="3" class="xl70" width="135" style="border-bottom:1.0pt;
  border-top:none;width:101pt">查看 Topic 消息队列offset</td>
  <td class="xl65" width="149" style="width:112pt">-t</td>
  <td class="xl66" width="159" style="width:119pt">topic 名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl65" width="149" style="height:17.0pt;width:112pt">-h</td>
  <td class="xl66" width="159" style="width:119pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl65" width="149" style="height:43.0pt;width:112pt">-n</td>
  <td class="xl66" width="159" style="width:119pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="3" height="103" class="xl68" width="163" style="border-bottom:1.0pt;
  height:77.0pt;border-top:none;width:122pt">topicClusterList</td>
  <td rowspan="3" class="xl70" width="135" style="border-bottom:1.0pt;
  border-top:none;width:101pt">查看 Topic 所在集群列表</td>
  <td class="xl65" width="149" style="width:112pt">-t</td>
  <td class="xl66" width="159" style="width:119pt">topic 名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl65" width="149" style="height:17.0pt;width:112pt">-h</td>
  <td class="xl66" width="159" style="width:119pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl65" width="149" style="height:43.0pt;width:112pt">-n</td>
  <td class="xl66" width="159" style="width:119pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="6" height="518" class="xl68" width="163" style="border-bottom:1.0pt;
  height:380pt;border-top:none;width:122pt">updateTopicPerm</td>
  <td rowspan="6" class="xl70" width="135" style="border-bottom:1.0pt;
  border-top:none;width:101pt">更新 Topic 读写权限</td>
  <td class="xl65" width="149" style="width:112pt">-t</td>
  <td class="xl66" width="159" style="width:119pt">topic 名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl65" width="149" style="height:17.0pt;width:112pt">-h</td>
  <td class="xl66" width="159" style="width:119pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl65" width="149" style="height:43.0pt;width:112pt">-n</td>
  <td class="xl66" width="159" style="width:119pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="132" style="height:99.0pt">
  <td height="132" class="xl65" width="149" style="height:99.0pt;width:112pt">-b</td>
  <td class="xl66" width="159" style="width:119pt">Broker 地址，表示 topic 所在
  Broker，只支持单台Broker，地址为ip:port</td>
 </tr>
 <tr height="76" style="height:57.0pt">
  <td height="76" class="xl65" width="149" style="height:57.0pt;width:112pt">-p</td>
  <td class="xl66" width="159" style="width:119pt">指定新 topic 的读写权限( W=2|R=4|WR=6 )</td>
 </tr>
 <tr height="207" style="height:155.0pt">
  <td height="207" class="xl65" width="149" style="height:155.0pt;width:112pt">-c</td>
  <td class="xl66" width="159" style="width:119pt">cluster 名称，表示 topic 所在集群（集群可通过
  clusterList 查询），-b优先，如果没有-b，则对集群中所有Broker执行命令</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="5" height="199" class="xl68" width="163" style="border-bottom:1.0pt;
  height:149.0pt;border-top:none;width:122pt">updateOrderConf</td>
  <td rowspan="5" class="xl70" width="135" style="border-bottom:1.0pt;
  border-top:none;width:101pt">从NameServer上创建、删除、获取特定命名空间的kv配置，目前还未启用</td>
  <td class="xl65" width="149" style="width:112pt">-h</td>
  <td class="xl66" width="159" style="width:119pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl65" width="149" style="height:43.0pt;width:112pt">-n</td>
  <td class="xl66" width="159" style="width:119pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl65" width="149" style="height:17.0pt;width:112pt">-t</td>
  <td class="xl66" width="159" style="width:119pt">topic，键</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl65" width="149" style="height:29.0pt;width:112pt">-v</td>
  <td class="xl66" width="159" style="width:119pt">orderConf，值</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl65" width="149" style="height:43.0pt;width:112pt">-m</td>
  <td class="xl66" width="159" style="width:119pt">method，可选get、put、delete</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="4" height="198" class="xl68" width="163" style="border-bottom:1.0pt;
  height:140pt;border-top:none;width:122pt">allocateMQ</td>
  <td rowspan="4" class="xl70" width="135" style="border-bottom:1.0pt;
  border-top:none;width:101pt">以平均负载算法计算消费者列表负载消息队列的负载结果</td>
  <td class="xl65" width="149" style="width:112pt">-t</td>
  <td class="xl66" width="159" style="width:119pt">topic 名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl65" width="149" style="height:17.0pt;width:112pt">-h</td>
  <td class="xl66" width="159" style="width:119pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl65" width="149" style="height:43.0pt;width:112pt">-n</td>
  <td class="xl66" width="159" style="width:119pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="95" style="height:71.0pt">
  <td height="95" class="xl65" width="149" style="height:71.0pt;width:112pt">-i</td>
  <td class="xl66" width="159" style="width:119pt">ipList，用逗号分隔，计算这些ip去负载Topic的消息队列</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="4" height="142" class="xl68" width="163" style="border-bottom:1.0pt solid black;
  height:106.0pt;border-top:1.0pt;width:122pt">statsAll</td>
  <td rowspan="4" class="xl70" width="135" style="border-bottom:1.0pt;
  border-top:none;width:101pt">打印Topic订阅关系、TPS、积累量、24h读写总量等信息</td>
  <td class="xl65" width="149" style="width:112pt">-h</td>
  <td class="xl66" width="159" style="width:119pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl65" width="149" style="height:43.0pt;width:112pt">-n</td>
  <td class="xl66" width="159" style="width:119pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl65" width="149" style="height:29.0pt;width:112pt">-a</td>
  <td class="xl66" width="159" style="width:119pt">是否只打印活跃topic</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl65" width="149" style="height:17.0pt;width:112pt">-t</td>
  <td class="xl66" width="159" style="width:119pt">指定topic</td>
 </tr>
</tbody></table>


<p>####2）集群相关</p>
<table border="0" cellpadding="0" cellspacing="0" width="714">
 <colgroup><col width="177">
 <col width="175">
 <col width="177">
 <col width="185">
 </colgroup><tbody><tr height="23" style="height:17.0pt">
  <td height="23" class="xl63" width="177" style="height:17.0pt;width:133pt">名称</td>
  <td class="xl64" width="175" style="width:131pt">含义</td>
  <td class="xl64" width="177" style="width:133pt">命令选项</td>
  <td class="xl64" width="185" style="width:139pt">说明</td>
 </tr>
 <tr height="207" style="height:155.0pt">
  <td rowspan="4" height="326" class="xl67" width="177" style="border-bottom:1.0pt;
  height:244.0pt;border-top:none;width:133pt"><span style="mso-spacerun:yes"> </span>clusterList</td>
  <td rowspan="4" class="xl70" width="175" style="border-bottom:1.0pt;
  border-top:none;width:131pt">查看集群信息，集群、BrokerName、BrokerId、TPS等信息</td>
  <td class="xl65" width="177" style="width:133pt">-m</td>
  <td class="xl66" width="185" style="width:139pt">打印更多信息 (增加打印出如下信息 #InTotalYest,
  #OutTotalYest, #InTotalToday ,#OutTotalToday)</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl65" width="177" style="height:17.0pt;width:133pt">-h</td>
  <td class="xl66" width="185" style="width:139pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl65" width="177" style="height:43.0pt;width:133pt">-n</td>
  <td class="xl66" width="185" style="width:139pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl65" width="177" style="height:29.0pt;width:133pt">-i</td>
  <td class="xl66" width="185" style="width:139pt">打印间隔，单位秒</td>
 </tr>
 <tr height="95" style="height:71.0pt">
  <td rowspan="8" height="391" class="xl67" width="177" style="border-bottom:1.0pt;
  height:292.0pt;border-top:none;width:133pt">clusterRT</td>
  <td rowspan="8" class="xl70" width="175" style="border-bottom:1.0pt;
  border-top:none;width:131pt">发送消息检测集群各Broker RT。消息发往${BrokerName} Topic。</td>
  <td class="xl65" width="177" style="width:133pt">-a</td>
  <td class="xl66" width="185" style="width:139pt">amount，每次探测的总数，RT = 总时间 /
  amount</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl65" width="177" style="height:29.0pt;width:133pt">-s</td>
  <td class="xl66" width="185" style="width:139pt">消息大小，单位B</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl65" width="177" style="height:17.0pt;width:133pt">-c</td>
  <td class="xl66" width="185" style="width:139pt">探测哪个集群</td>
 </tr>
 <tr height="76" style="height:57.0pt">
  <td height="76" class="xl65" width="177" style="height:57.0pt;width:133pt">-p</td>
  <td class="xl66" width="185" style="width:139pt">是否打印格式化日志，以|分割，默认不打印</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl65" width="177" style="height:17.0pt;width:133pt">-h</td>
  <td class="xl66" width="185" style="width:139pt">打印帮助</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl65" width="177" style="height:29.0pt;width:133pt">-m</td>
  <td class="xl66" width="185" style="width:139pt">所属机房，打印使用</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl65" width="177" style="height:29.0pt;width:133pt">-i</td>
  <td class="xl66" width="185" style="width:139pt">发送间隔，单位秒</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl65" width="177" style="height:43.0pt;width:133pt">-n</td>
  <td class="xl66" width="185" style="width:139pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
</tbody></table>


<p>####3）Broker相关</p>
<table border="0" cellpadding="0" cellspacing="0" width="714">
 <colgroup><col width="177">
 <col width="175">
 <col width="177">
 <col width="185">
 </colgroup><tbody><tr height="23" style="height:17.0pt">
  <td height="23" class="xl63" width="177" style="height:17.0pt;width:133pt">名称</td>
  <td class="xl64" width="175" style="width:131pt">含义</td>
  <td class="xl64" width="177" style="width:133pt">命令选项</td>
  <td class="xl64" width="185" style="width:139pt">说明</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td rowspan="6" height="206" class="xl69" width="191" style="border-bottom:1.0pt;
  height:154.0pt;border-top:none;width:143pt">updateBrokerConfig</td>
  <td rowspan="6" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">更新 Broker 配置文件，会修改Broker.conf</td>
  <td class="xl67" width="87" style="width:65pt">-b</td>
  <td class="xl68" width="87" style="width:65pt">Broker 地址，格式为ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-c</td>
  <td class="xl68" width="87" style="width:65pt">cluster 名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-k</td>
  <td class="xl68" width="87" style="width:65pt">key 值</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-v</td>
  <td class="xl68" width="87" style="width:65pt">value 值</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td rowspan="3" height="137" class="xl69" width="191" style="border-bottom:1.0pt;
  height:103.0pt;border-top:none;width:143pt">brokerStatus</td>
  <td rowspan="3" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">查看 Broker 统计信息、运行状态（你想要的信息几乎都在里面）</td>
  <td class="xl67" width="87" style="width:65pt">-b</td>
  <td class="xl68" width="87" style="width:65pt">Broker 地址，地址为ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td rowspan="6" height="256" class="xl69" width="191" style="border-bottom:1.0pt;
  height:192.0pt;border-top:none;width:143pt">brokerConsumeStats</td>
  <td rowspan="6" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">Broker中各个消费者的消费情况，按Message Queue维度返回Consume
  Offset，Broker Offset，Diff，TImestamp等信息</td>
  <td class="xl67" width="87" style="width:65pt">-b</td>
  <td class="xl68" width="87" style="width:65pt">Broker 地址，地址为ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-t</td>
  <td class="xl68" width="87" style="width:65pt">请求超时时间</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-l</td>
  <td class="xl68" width="87" style="width:65pt">diff阈值，超过阈值才打印</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-o</td>
  <td class="xl68" width="87" style="width:65pt">是否为顺序topic，一般为false</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td rowspan="2" height="114" class="xl69" width="191" style="border-bottom:1.0pt;
  height:86.0pt;border-top:none;width:143pt">getBrokerConfig</td>
  <td rowspan="2" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">获取Broker配置</td>
  <td class="xl67" width="87" style="width:65pt">-b</td>
  <td class="xl68" width="87" style="width:65pt">Broker 地址，地址为ip:port</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td rowspan="3" height="137" class="xl69" width="191" style="border-bottom:1.0pt;
  height:103.0pt;border-top:none;width:143pt">wipeWritePerm</td>
  <td rowspan="3" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">从NameServer上清除 Broker写权限</td>
  <td class="xl67" width="87" style="width:65pt">-b</td>
  <td class="xl68" width="87" style="width:65pt">Broker 地址，地址为ip:port</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td rowspan="4" height="160" class="xl69" width="191" style="border-bottom:1.0pt;
  height:120.0pt;border-top:none;width:143pt">cleanExpiredCQ</td>
  <td rowspan="4" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">清理Broker上过期的Consume Queue，如果手动减少对列数可能产生过期队列</td>
  <td class="xl67" width="87" style="width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-b</td>
  <td class="xl68" width="87" style="width:65pt">Broker 地址，地址为ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-c</td>
  <td class="xl68" width="87" style="width:65pt">集群名称</td>
 </tr>
 <tr height="88" style="mso-height-source:userset;height:66.0pt">
  <td rowspan="4" height="191" class="xl69" width="191" style="border-bottom:1.0pt;
  height:143.0pt;border-top:none;width:143pt">cleanUnusedTopic</td>
  <td rowspan="4" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">清理Broker上不使用的Topic，从内存中释放Topic的Consume
  Queue，如果手动删除Topic会产生不使用的Topic</td>
  <td class="xl67" width="87" style="width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-b</td>
  <td class="xl68" width="87" style="width:65pt">Broker 地址，地址为ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-c</td>
  <td class="xl68" width="87" style="width:65pt">集群名称</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td rowspan="5" height="199" class="xl69" width="191" style="border-bottom:1.0pt;
  height:149.0pt;border-top:none;width:143pt">sendMsgStatus</td>
  <td rowspan="5" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">向Broker发消息，返回发送状态和RT</td>
  <td class="xl67" width="87" style="width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-b</td>
  <td class="xl68" width="87" style="width:65pt">BrokerName，注意不同于Broker地址</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-s</td>
  <td class="xl68" width="87" style="width:65pt">消息大小，单位B</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-c</td>
  <td class="xl68" width="87" style="width:65pt">发送次数</td>
 </tr>
</tbody></table>


<p>####4）消息相关</p>
<table border="0" cellpadding="0" cellspacing="0" width="714">
 <colgroup><col width="177">
 <col width="175">
 <col width="177">
 <col width="185">
</colgroup><tbody><tr height="23" style="height:17.0pt">
  <td height="23" class="xl63" width="177" style="height:17.0pt;width:133pt">名称</td>
  <td class="xl64" width="175" style="width:131pt">含义</td>
  <td class="xl64" width="177" style="width:133pt">命令选项</td>
  <td class="xl64" width="185" style="width:139pt">说明</td>
 </tr>
 <tr height="128" style="height:96.0pt">
  <td rowspan="3" height="208" class="xl69" width="87" style="border-bottom:1.0pt;
  height:156.0pt;border-top:none;width:65pt">queryMsgById</td>
  <td rowspan="3" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">根据offsetMsgId查询msg，如果使用开源控制台，应使用offsetMsgId，此命令还有其他参数，具体作用请阅读QueryMsgByIdSubCommand。</td>
  <td class="xl67" width="87" style="width:65pt">-i</td>
  <td class="xl67" width="87" style="width:65pt">msgId</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="4" height="126" class="xl69" width="87" style="border-bottom:1.0pt;
  height:94.0pt;border-top:none;width:65pt">queryMsgByKey</td>
  <td rowspan="4" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">根据消息 Key 查询消息</td>
  <td class="xl67" width="87" style="width:65pt">-k</td>
  <td class="xl67" width="87" style="width:65pt">msgKey</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-t</td>
  <td class="xl68" width="87" style="width:65pt">Topic 名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="225" style="height:169.0pt">
  <td rowspan="6" height="390" class="xl69" width="87" style="border-bottom:1.0pt;
  height:292.0pt;border-top:none;width:65pt">queryMsgByOffset</td>
  <td rowspan="6" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">根据 Offset 查询消息</td>
  <td class="xl67" width="87" style="width:65pt">-b</td>
  <td class="xl68" width="87" style="width:65pt">Broker 名称，（这里需要注意
  填写的是 Broker 的名称，不是 Broker 的地址，Broker 名称可以在 clusterList 查到）</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-i</td>
  <td class="xl68" width="87" style="width:65pt">query 队列 id</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-o</td>
  <td class="xl68" width="87" style="width:65pt">offset 值</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-t</td>
  <td class="xl68" width="87" style="width:65pt">topic 名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="47">
  <td rowspan="6" height="209" class="xl69" width="87" style="border-bottom:1.0pt;
  height:156.0pt;border-top:none;width:65pt">queryMsgByUniqueKey</td>
  <td rowspan="6" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">根据msgId查询，msgId不同于offsetMsgId，区别详见常见运维问题。-g，-d配合使用，查到消息后尝试让特定的消费者消费消息并返回消费结果</td>
  <td class="xl67" width="87" style="width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-i</td>
  <td class="xl67" width="87" style="width:65pt">uniqe msg id</td>
 </tr>
 <tr height="36" style="height:27.0pt">
  <td height="36" class="xl67" width="87" style="height:27.0pt;width:65pt">-g</td>
  <td class="xl67" width="87" style="width:65pt">consumerGroup</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-d</td>
  <td class="xl67" width="87" style="width:65pt">clientId</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-t</td>
  <td class="xl68" width="87" style="width:65pt">topic名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="5" height="149" class="xl69" width="87" style="border-bottom:1.0pt
  height:111.0pt;border-top:none;width:65pt">checkMsgSendRT</td>
  <td rowspan="5" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">检测向topic发消息的RT，功能类似clusterRT</td>
  <td class="xl67" width="87" style="width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-t</td>
  <td class="xl68" width="87" style="width:65pt">topic名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-a</td>
  <td class="xl68" width="87" style="width:65pt">探测次数</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-s</td>
  <td class="xl68" width="87" style="width:65pt">消息大小</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="8" height="218" class="xl69" width="87" style="border-bottom:1.0pt;
  height:162.0pt;border-top:none;width:65pt">sendMessage</td>
  <td rowspan="8" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">发送一条消息，可以根据配置发往特定Message Queue，或普通发送。</td>
  <td class="xl67" width="87" style="width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-t</td>
  <td class="xl68" width="87" style="width:65pt">topic名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-p</td>
  <td class="xl68" width="87" style="width:65pt">body，消息体</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-k</td>
  <td class="xl67" width="87" style="width:65pt">keys</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-c</td>
  <td class="xl67" width="87" style="width:65pt">tags</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-b</td>
  <td class="xl67" width="87" style="width:65pt">BrokerName</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-i</td>
  <td class="xl67" width="87" style="width:65pt">queueId</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="10" height="312" class="xl69" width="87" style="border-bottom:1.0pt;
  height:232.0pt;border-top:none;width:65pt">consumeMessage</td>
  <td rowspan="10" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">消费消息。可以根据offset、开始&amp;结束时间戳、消息队列消费消息，配置不同执行不同消费逻辑，详见ConsumeMessageCommand。</td>
  <td class="xl67" width="87" style="width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-t</td>
  <td class="xl68" width="87" style="width:65pt">topic名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-b</td>
  <td class="xl67" width="87" style="width:65pt">BrokerName</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-o</td>
  <td class="xl68" width="87" style="width:65pt">从offset开始消费</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-i</td>
  <td class="xl67" width="87" style="width:65pt">queueId</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-g</td>
  <td class="xl68" width="87" style="width:65pt">消费者分组</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-s</td>
  <td class="xl68" width="87" style="width:65pt">开始时间戳，格式详见-h</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-d</td>
  <td class="xl68" width="87" style="width:65pt">结束时间戳</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-c</td>
  <td class="xl68" width="87" style="width:65pt">消费多少条消息</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="8" height="282" class="xl69" width="87" style="border-bottom:1.0pt;
  height:210.0pt;border-top:none;width:65pt">printMsg</td>
  <td rowspan="8" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">从Broker消费消息并打印，可选时间段</td>
  <td class="xl67" width="87" style="width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-t</td>
  <td class="xl68" width="87" style="width:65pt">topic名称</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-c</td>
  <td class="xl68" width="87" style="width:65pt">字符集，例如UTF-8</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-s</td>
  <td class="xl68" width="87" style="width:65pt">subExpress，过滤表达式</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-b</td>
  <td class="xl68" width="87" style="width:65pt">开始时间戳，格式参见-h</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-e</td>
  <td class="xl68" width="87" style="width:65pt">结束时间戳</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-d</td>
  <td class="xl68" width="87" style="width:65pt">是否打印消息体</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="12" height="390" class="xl69" width="87" style="border-bottom:1.0pt;
  height:290.0pt;border-top:none;width:65pt">printMsgByQueue</td>
  <td rowspan="12" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">类似printMsg，但指定Message Queue</td>
  <td class="xl67" width="87" style="width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-t</td>
  <td class="xl68" width="87" style="width:65pt">topic名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-i</td>
  <td class="xl67" width="87" style="width:65pt">queueId</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-a</td>
  <td class="xl67" width="87" style="width:65pt">BrokerName</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-c</td>
  <td class="xl68" width="87" style="width:65pt">字符集，例如UTF-8</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-s</td>
  <td class="xl68" width="87" style="width:65pt">subExpress，过滤表达式</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-b</td>
  <td class="xl68" width="87" style="width:65pt">开始时间戳，格式参见-h</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-e</td>
  <td class="xl68" width="87" style="width:65pt">结束时间戳</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-p</td>
  <td class="xl68" width="87" style="width:65pt">是否打印消息</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-d</td>
  <td class="xl68" width="87" style="width:65pt">是否打印消息体</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-f</td>
  <td class="xl68" width="87" style="width:65pt">是否统计tag数量并打印</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="7" height="410" class="xl69" width="87" style="border-bottom:1.0pt;
  height:307.0pt;border-top:none;width:65pt">resetOffsetByTime</td>
  <td rowspan="7" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">按时间戳重置offset，Broker和consumer都会重置</td>
  <td class="xl67" width="87" style="width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-g</td>
  <td class="xl68" width="87" style="width:65pt">消费者分组</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-t</td>
  <td class="xl68" width="87" style="width:65pt">topic名称</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-s</td>
  <td class="xl68" width="87" style="width:65pt">重置为此时间戳对应的offset</td>
 </tr>
 <tr height="188" style="height:141.0pt">
  <td height="188" class="xl67" width="87" style="height:141.0pt;width:65pt">-f</td>
  <td class="xl68" width="87" style="width:65pt">是否强制重置，如果false，只支持回溯offset，如果true，不管时间戳对应offset与consumeOffset关系</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-c</td>
  <td class="xl68" width="87" style="width:65pt">是否重置c++客户端offset</td>
 </tr>
</tbody></table>


<h4 id="5）消费者、消费组相关"><a href="#5）消费者、消费组相关" class="headerlink" title="5）消费者、消费组相关"></a>5）消费者、消费组相关</h4><table border="0" cellpadding="0" cellspacing="0" width="714">
 <colgroup><col width="177">
 <col width="175">
 <col width="177">
 <col width="185">
</colgroup><tbody><tr height="23" style="height:17.0pt">
  <td height="23" class="xl63" width="177" style="height:17.0pt;width:133pt">名称</td>
  <td class="xl64" width="175" style="width:131pt">含义</td>
  <td class="xl64" width="177" style="width:133pt">命令选项</td>
  <td class="xl64" width="185" style="width:139pt">说明</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td rowspan="4" height="158" class="xl69" width="87" style="border-bottom:1.0pt;
  height:110pt;border-top:none;width:65pt">consumerProgress</td>
  <td rowspan="4" class="xl72" width="87" style="border-bottom:1.0pt;
  border-top:none;width:65pt">查看订阅组消费状态，可以查看具体的client IP的消息积累量</td>
  <td class="xl67" width="87" style="width:65pt">-g</td>
  <td class="xl68" width="87" style="width:65pt">消费者所属组名</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-s</td>
  <td class="xl68" width="87" style="width:65pt">是否打印client IP</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="105" style="mso-height-source:userset;height:79.0pt">
  <td rowspan="5" height="260" class="xl69" width="87" style="border-bottom:1.0pt;
  height:195.0pt;border-top:none;width:65pt">consumerStatus</td>
  <td rowspan="5" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">查看消费者状态，包括同一个分组中是否都是相同的订阅，分析Process
  Queue是否堆积，返回消费者jstack结果，内容较多，使用者参见ConsumerStatusSubCommand</td>
  <td class="xl67" width="87" style="width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="36" style="height:27.0pt">
  <td height="36" class="xl67" width="87" style="height:27.0pt;width:65pt">-g</td>
  <td class="xl67" width="87" style="width:65pt">consumer group</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-i</td>
  <td class="xl67" width="87" style="width:65pt">clientId</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-s</td>
  <td class="xl68" width="87" style="width:65pt">是否执行jstack</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td rowspan="5" height="181" class="xl69" width="87" style="border-bottom:1.0pt
  height:135.0pt;border-top:none;width:65pt">getConsumerStatus</td>
  <td rowspan="5" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">获取 Consumer 消费进度</td>
  <td class="xl67" width="87" style="width:65pt">-g</td>
  <td class="xl68" width="87" style="width:65pt">消费者所属组名</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-t</td>
  <td class="xl68" width="87" style="width:65pt">查询主题</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-i</td>
  <td class="xl68" width="87" style="width:65pt">Consumer 客户端 ip</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td rowspan="13" height="761" class="xl69" width="87" style="border-bottom:1.0pt
  height:569.0pt;border-top:none;width:65pt">updateSubGroup</td>
  <td rowspan="13" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">更新或创建订阅关系</td>
  <td class="xl67" width="87" style="width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-b</td>
  <td class="xl68" width="87" style="width:65pt">Broker地址</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-c</td>
  <td class="xl68" width="87" style="width:65pt">集群名称</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-g</td>
  <td class="xl68" width="87" style="width:65pt">消费者分组名称</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-s</td>
  <td class="xl68" width="87" style="width:65pt">分组是否允许消费</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-m</td>
  <td class="xl68" width="87" style="width:65pt">是否从最小offset开始消费</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-d</td>
  <td class="xl68" width="87" style="width:65pt">是否是广播模式</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-q</td>
  <td class="xl68" width="87" style="width:65pt">重试队列数量</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-r</td>
  <td class="xl68" width="87" style="width:65pt">最大重试次数</td>
 </tr>
 <tr height="207" style="height:155.0pt">
  <td height="207" class="xl67" width="87" style="height:155.0pt;width:65pt">-i</td>
  <td class="xl68" width="87" style="width:65pt">当slaveReadEnable开启时有效，且还未达到从slave消费时建议从哪个BrokerId消费，可以配置备机id，主动从备机消费</td>
 </tr>
 <tr height="132" style="height:99.0pt">
  <td height="132" class="xl67" width="87" style="height:99.0pt;width:65pt">-w</td>
  <td class="xl68" width="87" style="width:65pt">如果Broker建议从slave消费，配置决定从哪个slave消费，配置BrokerId，例如1</td>
 </tr>
 <tr height="76" style="height:57.0pt">
  <td height="76" class="xl67" width="87" style="height:57.0pt;width:65pt">-a</td>
  <td class="xl68" width="87" style="width:65pt">当消费者数量变化时是否通知其他消费者负载均衡</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td rowspan="5" height="165" class="xl69" width="87" style="border-bottom:1.0pt
  height:123.0pt;border-top:none;width:65pt">deleteSubGroup</td>
  <td rowspan="5" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">从Broker删除订阅关系</td>
  <td class="xl67" width="87" style="width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-b</td>
  <td class="xl68" width="87" style="width:65pt">Broker地址</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-c</td>
  <td class="xl68" width="87" style="width:65pt">集群名称</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td height="39" class="xl67" width="87" style="height:29.0pt;width:65pt">-g</td>
  <td class="xl68" width="87" style="width:65pt">消费者分组名称</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td rowspan="6" height="172" class="xl69" width="87" style="border-bottom:1.0pt
  height:120pt;border-top:none;width:65pt">cloneGroupOffset</td>
  <td rowspan="6" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">在目标群组中使用源群组的offset</td>
  <td class="xl67" width="87" style="width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-s</td>
  <td class="xl68" width="87" style="width:65pt">源消费者组</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-d</td>
  <td class="xl68" width="87" style="width:65pt">目标消费者组</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-t</td>
  <td class="xl68" width="87" style="width:65pt">topic名称</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-o</td>
  <td class="xl68" width="87" style="width:65pt">暂未使用</td>
 </tr>
</tbody></table>


<h4 id="6）连接相关"><a href="#6）连接相关" class="headerlink" title="6）连接相关"></a>6）连接相关</h4><table border="0" cellpadding="0" cellspacing="0" width="714">
 <colgroup><col width="177">
 <col width="175">
 <col width="177">
 <col width="185">
</colgroup><tbody><tr height="23" style="height:17.0pt">
  <td height="23" class="xl63" width="177" style="height:17.0pt;width:133pt">名称</td>
  <td class="xl64" width="175" style="width:131pt">含义</td>
  <td class="xl64" width="177" style="width:133pt">命令选项</td>
  <td class="xl64" width="185" style="width:139pt">说明</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td rowspan="3" height="119" class="xl69" width="87" style="border-bottom:1.0pt
  height:89.0pt;border-top:none;width:65pt">consumerConnec tion</td>
  <td rowspan="3" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">查询 Consumer 的网络连接</td>
  <td class="xl67" width="87" style="width:65pt">-g</td>
  <td class="xl68" width="87" style="width:65pt">消费者所属组名</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="39" style="height:29.0pt">
  <td rowspan="4" height="142" class="xl69" width="87" style="border-bottom:1.0pt
  height:106.0pt;border-top:none;width:65pt">producerConnec tion</td>
  <td rowspan="4" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">查询 Producer 的网络连接</td>
  <td class="xl67" width="87" style="width:65pt">-g</td>
  <td class="xl68" width="87" style="width:65pt">生产者所属组名</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-t</td>
  <td class="xl68" width="87" style="width:65pt">主题名称</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
</tbody></table>


<h4 id="7）NameServer相关"><a href="#7）NameServer相关" class="headerlink" title="7）NameServer相关"></a>7）NameServer相关</h4><table border="0" cellpadding="0" cellspacing="0" width="714">
 <colgroup><col width="177">
 <col width="175">
 <col width="177">
 <col width="185">
</colgroup><tbody><tr height="23" style="height:17.0pt">
  <td height="23" class="xl63" width="177" style="height:17.0pt;width:133pt">名称</td>
  <td class="xl64" width="175" style="width:131pt">含义</td>
  <td class="xl64" width="177" style="width:133pt">命令选项</td>
  <td class="xl64" width="185" style="width:139pt">说明</td>
 </tr>
 <tr height="21" style="height:16.0pt">
  <td rowspan="5" height="143" class="xl69" width="87" style="border-bottom:1.0pt
  height:100pt;border-top:none;width:65pt">updateKvConfig</td>
  <td rowspan="5" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">更新NameServer的kv配置，目前还未使用</td>
  <td class="xl75" width="87" style="width:65pt">-s</td>
  <td class="xl76" width="87" style="width:65pt">命名空间</td>
 </tr>
 <tr height="21" style="height:16.0pt">
  <td height="21" class="xl75" width="87" style="height:16.0pt;width:65pt">-k</td>
  <td class="xl75" width="87" style="width:65pt">key</td>
 </tr>
 <tr height="21" style="height:16.0pt">
  <td height="21" class="xl75" width="87" style="height:16.0pt;width:65pt">-v</td>
  <td class="xl75" width="87" style="width:65pt">value</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td rowspan="4" height="126" class="xl69" width="87" style="border-bottom:1.0pt
  height:94.0pt;border-top:none;width:65pt">deleteKvConfig</td>
  <td rowspan="4" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">删除NameServer的kv配置</td>
  <td class="xl67" width="87" style="width:65pt">-s</td>
  <td class="xl68" width="87" style="width:65pt">命名空间</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-k</td>
  <td class="xl67" width="87" style="width:65pt">key</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td height="57" class="xl67" width="87" style="height:43.0pt;width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td rowspan="2" height="80" class="xl69" width="87" style="border-bottom:1.0pt
  height:60.0pt;border-top:none;width:65pt">getNamesrvConfig</td>
  <td rowspan="2" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">获取NameServer配置</td>
  <td class="xl67" width="87" style="width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td rowspan="4" height="126" class="xl69" width="87" style="border-bottom:1.0pt
  height:94.0pt;border-top:none;width:65pt">updateNamesrvConfig</td>
  <td rowspan="4" class="xl72" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">修改NameServer配置</td>
  <td class="xl67" width="87" style="width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-k</td>
  <td class="xl67" width="87" style="width:65pt">key</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-v</td>
  <td class="xl67" width="87" style="width:65pt">value</td>
 </tr>
</tbody></table>


<h4 id="8）其他"><a href="#8）其他" class="headerlink" title="8）其他"></a>8）其他</h4><table border="0" cellpadding="0" cellspacing="0" width="714">
 <colgroup><col width="177">
 <col width="175">
 <col width="177">
 <col width="185">
</colgroup><tbody><tr height="23" style="height:17.0pt">
  <td height="23" class="xl63" width="177" style="height:17.0pt;width:133pt">名称</td>
  <td class="xl64" width="175" style="width:131pt">含义</td>
  <td class="xl64" width="177" style="width:133pt">命令选项</td>
  <td class="xl64" width="185" style="width:139pt">说明</td>
 </tr>
 <tr height="57" style="height:43.0pt">
  <td rowspan="2" height="80" class="xl69" width="87" style="border-bottom:1.0pt
  height:60.0pt;border-top:none;width:65pt">startMonitoring</td>
  <td rowspan="2" class="xl71" width="87" style="border-bottom:1.0pt
  border-top:none;width:65pt">开启监控进程，监控消息误删、重试队列消息数等</td>
  <td class="xl67" width="87" style="width:65pt">-n</td>
  <td class="xl68" width="87" style="width:65pt">NameServer 服务地址，格式 ip:port</td>
 </tr>
 <tr height="23" style="height:17.0pt">
  <td height="23" class="xl67" width="87" style="height:17.0pt;width:65pt">-h</td>
  <td class="xl68" width="87" style="width:65pt">打印帮助</td>
 </tr>
</tbody></table>


<h3 id="3-4-3-注意事项"><a href="#3-4-3-注意事项" class="headerlink" title="3.4.3 注意事项"></a>3.4.3 注意事项</h3><ul>
<li>几乎所有命令都需要配置-n表示NameServer地址，格式为ip:port</li>
<li>几乎所有命令都可以通过-h获取帮助</li>
<li>如果既有Broker地址（-b）配置项又有clusterName（-c）配置项，则优先以Broker地址执行命令；如果不配置Broker地址，则对集群中所有主机执行命令</li>
</ul>
<h2 id="3-5-集群监控平台搭建"><a href="#3-5-集群监控平台搭建" class="headerlink" title="3.5 集群监控平台搭建"></a>3.5 集群监控平台搭建</h2><h3 id="3-5-1-概述"><a href="#3-5-1-概述" class="headerlink" title="3.5.1 概述"></a>3.5.1 概述</h3><p><code>RocketMQ</code>有一个对其扩展的开源项目<a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq-externals">incubator-rocketmq-externals</a>，这个项目中有一个子模块叫<code>rocketmq-console</code>，这个便是管理控制台项目了，先将<a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq-externals">incubator-rocketmq-externals</a>拉到本地，因为我们需要自己对<code>rocketmq-console</code>进行编译打包运行。</p>
<p><img src="/2021/06/04/RocketMQ-1/rocketmq-console.png" alt="rocketmq-console.png"></p>
<h3 id="3-5-2-下载并编译打包"><a href="#3-5-2-下载并编译打包" class="headerlink" title="3.5.2 下载并编译打包"></a>3.5.2 下载并编译打包</h3><pre class=" language-sh"><code class="language-sh">git clone https://github.com/apache/rocketmq-externals
cd rocketmq-console
mvn clean package -Dmaven.test.skip=true
</code></pre>
<p>注意：打包前在<code>rocketmq-console</code>中配置<code>namesrv</code>集群地址：</p>
<pre class=" language-sh"><code class="language-sh">rocketmq.config.namesrvAddr=192.168.25.135:9876;192.168.25.138:9876
</code></pre>
<p>启动rocketmq-console：</p>
<pre class=" language-sh"><code class="language-sh">java -jar rocketmq-console-ng-1.0.0.jar
</code></pre>
<p>启动成功后，我们就可以通过浏览器访问<code>http://localhost:8080</code>进入控制台界面了，如下图：</p>
<p><img src="/2021/06/04/RocketMQ-1/rocketmq-console2.png" alt="rocketmq-console2.png"></p>
<p>集群状态：</p>
<p><img src="/2021/06/04/RocketMQ-1/rocketmq-console3.png" alt="rocketmq-console3.png"></p>
<h1 id="4-消息发送样例"><a href="#4-消息发送样例" class="headerlink" title="4. 消息发送样例"></a>4. 消息发送样例</h1><ul>
<li>导入MQ客户端依赖</li>
</ul>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.rocketmq<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>rocketmq-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>4.4.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
</code></pre>
<ul>
<li>消息发送者步骤分析r</li>
</ul>
<pre class=" language-tex"><code class="language-tex">1.创建消息生产者producer，并制定生产者组名
2.指定Nameserver地址
3.启动producer
4.创建消息对象，指定主题Topic、Tag和消息体
5.发送消息
6.关闭生产者producer
</code></pre>
<ul>
<li>消息消费者步骤分析</li>
</ul>
<pre class=" language-tex"><code class="language-tex">1.创建消费者Consumer，制定消费者组名
2.指定Nameserver地址
3.订阅主题Topic和Tag
4.设置回调函数，处理消息
5.启动消费者consumer
</code></pre>
<h2 id="4-1-基本样例"><a href="#4-1-基本样例" class="headerlink" title="4.1 基本样例"></a>4.1 基本样例</h2><h3 id="4-1-1-消息发送"><a href="#4-1-1-消息发送" class="headerlink" title="4.1.1 消息发送"></a>4.1.1 消息发送</h3><h4 id="1）发送同步消息"><a href="#1）发送同步消息" class="headerlink" title="1）发送同步消息"></a>1）发送同步消息</h4><p>这种可靠性同步地发送方式使用的比较广泛，比如：重要的消息通知，短信通知。</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SyncProducer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 实例化消息生产者Producer</span>
        DefaultMQProducer producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"please_rename_unique_group_name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 设置NameServer的地址</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"localhost:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 启动Producer实例</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 创建消息，并指定Topic，Tag和消息体</span>
            Message msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span> <span class="token comment" spellcheck="true">/* Topic */</span><span class="token punctuation">,</span>
            <span class="token string">"TagA"</span> <span class="token comment" spellcheck="true">/* Tag */</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token string">"Hello RocketMQ "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>RemotingHelper<span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">/* Message body */</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 发送消息到一个Broker</span>
            SendResult sendResult <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 通过sendResult返回消息是否成功送达</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s%n"</span><span class="token punctuation">,</span> sendResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 如果不再发送消息，关闭Producer实例。</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="2）发送异步消息"><a href="#2）发送异步消息" class="headerlink" title="2）发送异步消息"></a>2）发送异步消息</h4><p>异步消息通常用在对响应时间敏感的业务场景，即发送端不能容忍长时间地等待Broker的响应。</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncProducer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 实例化消息生产者Producer</span>
        DefaultMQProducer producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"please_rename_unique_group_name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 设置NameServer的地址</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"localhost:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 启动Producer实例</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setRetryTimesWhenSendAsyncFailed</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> index <span class="token operator">=</span> i<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 创建消息，并指定Topic，Tag和消息体</span>
                Message msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span><span class="token punctuation">,</span>
                    <span class="token string">"TagA"</span><span class="token punctuation">,</span>
                    <span class="token string">"OrderID188"</span><span class="token punctuation">,</span>
                    <span class="token string">"Hello world"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>RemotingHelper<span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// SendCallback接收异步返回结果的回调</span>
                producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SendCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span>SendResult sendResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-10d OK %s %n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span>
                            sendResult<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onException</span><span class="token punctuation">(</span>Throwable e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%-10d Exception %s %n"</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 如果不再发送消息，关闭Producer实例。</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="3）单向发送消息"><a href="#3）单向发送消息" class="headerlink" title="3）单向发送消息"></a>3）单向发送消息</h4><p>这种方式主要用在不特别关心发送结果的场景，例如日志发送。</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OnewayProducer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 实例化消息生产者Producer</span>
        DefaultMQProducer producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"please_rename_unique_group_name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 设置NameServer的地址</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"localhost:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 启动Producer实例</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 创建消息，并指定Topic，Tag和消息体</span>
            Message msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span> <span class="token comment" spellcheck="true">/* Topic */</span><span class="token punctuation">,</span>
                <span class="token string">"TagA"</span> <span class="token comment" spellcheck="true">/* Tag */</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token string">"Hello RocketMQ "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>RemotingHelper<span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">/* Message body */</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 发送单向消息，没有任何返回结果</span>
            producer<span class="token punctuation">.</span><span class="token function">sendOneway</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 如果不再发送消息，关闭Producer实例。</span>
        producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="4-1-2-消费消息"><a href="#4-1-2-消费消息" class="headerlink" title="4.1.2 消费消息"></a>4.1.2 消费消息</h3><h4 id="1）负载均衡模式"><a href="#1）负载均衡模式" class="headerlink" title="1）负载均衡模式"></a>1）负载均衡模式</h4><p>消费者采用负载均衡方式消费消息，多个消费者共同消费队列消息，每个消费者处理的消息不同</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 实例化消息生产者,指定组名</span>
    DefaultMQPushConsumer consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"group1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 指定Namesrv地址信息.</span>
    consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"localhost:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 订阅Topic</span>
    consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"Test"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//负载均衡模式消费</span>
    consumer<span class="token punctuation">.</span><span class="token function">setMessageModel</span><span class="token punctuation">(</span>MessageModel<span class="token punctuation">.</span>CLUSTERING<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 注册回调函数，处理消息</span>
    consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> ConsumeConcurrentlyStatus <span class="token function">consumeMessage</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>MessageExt<span class="token operator">></span> msgs<span class="token punctuation">,</span>
                                                        ConsumeConcurrentlyContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s Receive New Messages: %s %n"</span><span class="token punctuation">,</span> 
                              Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ConsumeConcurrentlyStatus<span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//启动消息者</span>
    consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Consumer Started.%n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="2）广播模式"><a href="#2）广播模式" class="headerlink" title="2）广播模式"></a>2）广播模式</h4><p>消费者采用广播的方式消费消息，每个消费者消费的消息都是相同的</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 实例化消息生产者,指定组名</span>
    DefaultMQPushConsumer consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"group1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 指定Namesrv地址信息.</span>
    consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"localhost:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 订阅Topic</span>
    consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"Test"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//广播模式消费</span>
    consumer<span class="token punctuation">.</span><span class="token function">setMessageModel</span><span class="token punctuation">(</span>MessageModel<span class="token punctuation">.</span>BROADCASTING<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 注册回调函数，处理消息</span>
    consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> ConsumeConcurrentlyStatus <span class="token function">consumeMessage</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>MessageExt<span class="token operator">></span> msgs<span class="token punctuation">,</span>
                                                        ConsumeConcurrentlyContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s Receive New Messages: %s %n"</span><span class="token punctuation">,</span> 
                              Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ConsumeConcurrentlyStatus<span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//启动消息者</span>
    consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Consumer Started.%n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="4-2-顺序消息"><a href="#4-2-顺序消息" class="headerlink" title="4.2 顺序消息"></a>4.2 顺序消息</h2><p>消息有序指的是可以按照消息的发送顺序来消费(FIFO)。RocketMQ可以严格的保证消息有序，可以分为分区有序或者全局有序。</p>
<p>顺序消费的原理解析，在默认的情况下消息发送会采取Round Robin轮询方式把消息发送到不同的queue(分区队列)；而消费消息的时候从多个queue上拉取消息，这种情况发送和消费是不能保证顺序。但是如果控制发送的顺序消息只依次发送到同一个queue中，消费的时候只从这个queue上依次拉取，则就保证了顺序。当发送和消费参与的queue只有一个，则是全局有序；如果多个queue参与，则为分区有序，即相对每个queue，消息都是有序的。</p>
<p>下面用订单进行分区有序的示例。一个订单的顺序流程是：创建、付款、推送、完成。订单号相同的消息会被先后发送到同一个队列中，消费时，同一个OrderId获取到的肯定是同一个队列。</p>
<h3 id="4-2-1-顺序消息生产"><a href="#4-2-1-顺序消息生产" class="headerlink" title="4.2.1 顺序消息生产"></a>4.2.1 顺序消息生产</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
* Producer，发送顺序消息
*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token punctuation">{</span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
       DefaultMQProducer producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"please_rename_unique_group_name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       String<span class="token punctuation">[</span><span class="token punctuation">]</span> tags <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"TagA"</span><span class="token punctuation">,</span> <span class="token string">"TagC"</span><span class="token punctuation">,</span> <span class="token string">"TagD"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

       <span class="token comment" spellcheck="true">// 订单列表</span>
       List<span class="token operator">&lt;</span>OrderStep<span class="token operator">></span> orderList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Producer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buildOrders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       Date date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       SimpleDateFormat sdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd HH:mm:ss"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       String dateStr <span class="token operator">=</span> sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment" spellcheck="true">// 加个时间前缀</span>
           String body <span class="token operator">=</span> dateStr <span class="token operator">+</span> <span class="token string">" Hello RocketMQ "</span> <span class="token operator">+</span> orderList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
           Message msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span><span class="token punctuation">,</span> tags<span class="token punctuation">[</span>i <span class="token operator">%</span> tags<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"KEY"</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> body<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

           SendResult sendResult <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueueSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token annotation punctuation">@Override</span>
               <span class="token keyword">public</span> MessageQueue <span class="token function">select</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>MessageQueue<span class="token operator">></span> mqs<span class="token punctuation">,</span> Message msg<span class="token punctuation">,</span> Object arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   Long id <span class="token operator">=</span> <span class="token punctuation">(</span>Long<span class="token punctuation">)</span> arg<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//根据订单id选择发送queue</span>
                   <span class="token keyword">long</span> index <span class="token operator">=</span> id <span class="token operator">%</span> mqs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token keyword">return</span> mqs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
           <span class="token punctuation">}</span><span class="token punctuation">,</span> orderList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//订单id</span>

           System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"SendResult status:%s, queueId:%d, body:%s"</span><span class="token punctuation">,</span>
               sendResult<span class="token punctuation">.</span><span class="token function">getSendStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
               sendResult<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
               body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

       producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment" spellcheck="true">/**
    * 订单的步骤
    */</span>
   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">OrderStep</span> <span class="token punctuation">{</span>
       <span class="token keyword">private</span> <span class="token keyword">long</span> orderId<span class="token punctuation">;</span>
       <span class="token keyword">private</span> String desc<span class="token punctuation">;</span>

       <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getOrderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span> orderId<span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

       <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setOrderId</span><span class="token punctuation">(</span><span class="token keyword">long</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">this</span><span class="token punctuation">.</span>orderId <span class="token operator">=</span> orderId<span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

       <span class="token keyword">public</span> String <span class="token function">getDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span> desc<span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

       <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDesc</span><span class="token punctuation">(</span>String desc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">this</span><span class="token punctuation">.</span>desc <span class="token operator">=</span> desc<span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

       <span class="token annotation punctuation">@Override</span>
       <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">return</span> <span class="token string">"OrderStep{"</span> <span class="token operator">+</span>
               <span class="token string">"orderId="</span> <span class="token operator">+</span> orderId <span class="token operator">+</span>
               <span class="token string">", desc='"</span> <span class="token operator">+</span> desc <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>
               <span class="token string">'}'</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment" spellcheck="true">/**
    * 生成模拟订单数据
    */</span>
   <span class="token keyword">private</span> List<span class="token operator">&lt;</span>OrderStep<span class="token operator">></span> <span class="token function">buildOrders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       List<span class="token operator">&lt;</span>OrderStep<span class="token operator">></span> orderList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>OrderStep<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       OrderStep orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderStep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>15103111039L<span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"创建"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

       orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderStep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>15103111065L<span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"创建"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

       orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderStep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>15103111039L<span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"付款"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

       orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderStep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>15103117235L<span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"创建"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

       orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderStep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>15103111065L<span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"付款"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

       orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderStep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>15103117235L<span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"付款"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

       orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderStep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>15103111065L<span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

       orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderStep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>15103111039L<span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"推送"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

       orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderStep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>15103117235L<span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

       orderDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderStep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderDemo<span class="token punctuation">.</span><span class="token function">setOrderId</span><span class="token punctuation">(</span>15103111039L<span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderDemo<span class="token punctuation">.</span><span class="token function">setDesc</span><span class="token punctuation">(</span><span class="token string">"完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       orderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>orderDemo<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">return</span> orderList<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="4-2-2-顺序消费消息"><a href="#4-2-2-顺序消费消息" class="headerlink" title="4.2.2 顺序消费消息"></a>4.2.2 顺序消费消息</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
* 顺序消息消费，带事务方式（应用可控制Offset什么时候提交）
*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsumerInOrder</span> <span class="token punctuation">{</span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
       DefaultMQPushConsumer consumer <span class="token operator">=</span> <span class="token keyword">new</span> 
           <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"please_rename_unique_group_name_3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       consumer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment" spellcheck="true">/**
        * 设置Consumer第一次启动是从队列头部开始消费还是队列尾部开始消费&lt;br>
        * 如果非第一次启动，那么按照上次消费的位置继续消费
        */</span>
       consumer<span class="token punctuation">.</span><span class="token function">setConsumeFromWhere</span><span class="token punctuation">(</span>ConsumeFromWhere<span class="token punctuation">.</span>CONSUME_FROM_FIRST_OFFSET<span class="token punctuation">)</span><span class="token punctuation">;</span>

       consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span><span class="token punctuation">,</span> <span class="token string">"TagA || TagC || TagD"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerOrderly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

           Random random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

           <span class="token annotation punctuation">@Override</span>
           <span class="token keyword">public</span> ConsumeOrderlyStatus <span class="token function">consumeMessage</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>MessageExt<span class="token operator">></span> msgs<span class="token punctuation">,</span> ConsumeOrderlyContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               context<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token keyword">for</span> <span class="token punctuation">(</span>MessageExt msg <span class="token operator">:</span> msgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   <span class="token comment" spellcheck="true">// 可以看到每个queue有唯一的consume线程来消费, 订单对每个queue(分区)有序</span>
                   System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"consumeThread="</span> <span class="token operator">+</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"queueId="</span> <span class="token operator">+</span> msg<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", content:"</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>

               <span class="token keyword">try</span> <span class="token punctuation">{</span>
                   <span class="token comment" spellcheck="true">//模拟业务逻辑处理中...</span>
                   TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
               <span class="token keyword">return</span> ConsumeOrderlyStatus<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Consumer Started."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="4-3-延时消息"><a href="#4-3-延时消息" class="headerlink" title="4.3 延时消息"></a>4.3 延时消息</h2><p>比如电商里，提交了一个订单就可以发送一个延时消息，1h后去检查这个订单的状态，如果还是未付款就取消订单释放库存。</p>
<h3 id="4-3-1-启动消息消费者"><a href="#4-3-1-启动消息消费者" class="headerlink" title="4.3.1 启动消息消费者"></a>4.3.1 启动消息消费者</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScheduledMessageConsumer</span> <span class="token punctuation">{</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// 实例化消费者</span>
      DefaultMQPushConsumer consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"ExampleConsumer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">// 订阅Topics</span>
      consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"TestTopic"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">// 注册消息监听者</span>
      consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token annotation punctuation">@Override</span>
          <span class="token keyword">public</span> ConsumeConcurrentlyStatus <span class="token function">consumeMessage</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>MessageExt<span class="token operator">></span> messages<span class="token punctuation">,</span> ConsumeConcurrentlyContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">for</span> <span class="token punctuation">(</span>MessageExt message <span class="token operator">:</span> messages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token comment" spellcheck="true">// Print approximate delay time period</span>
                  System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Receive message[msgId="</span> <span class="token operator">+</span> message<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"] "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> message<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"ms later"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              <span class="token keyword">return</span> ConsumeConcurrentlyStatus<span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">// 启动消费者</span>
      consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="4-3-2-发送延时消息"><a href="#4-3-2-发送延时消息" class="headerlink" title="4.3.2 发送延时消息"></a>4.3.2 发送延时消息</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScheduledMessageProducer</span> <span class="token punctuation">{</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// 实例化一个生产者来产生延时消息</span>
      DefaultMQProducer producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"ExampleProducerGroup"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">// 启动生产者</span>
      producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> totalMessagesToSend <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> totalMessagesToSend<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          Message message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"TestTopic"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"Hello scheduled message "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment" spellcheck="true">// 设置延时等级3,这个消息将在10s之后发送(现在只支持固定的几个时间,详看delayTimeLevel)</span>
          message<span class="token punctuation">.</span><span class="token function">setDelayTimeLevel</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment" spellcheck="true">// 发送消息</span>
          producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
       <span class="token comment" spellcheck="true">// 关闭生产者</span>
      producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>###4.3.3 验证</p>
<p>您将会看到消息的消费比存储时间晚10秒</p>
<h3 id="4-3-4-使用限制"><a href="#4-3-4-使用限制" class="headerlink" title="4.3.4 使用限制"></a>4.3.4 使用限制</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// org/apache/rocketmq/store/config/MessageStoreConfig.java</span>
<span class="token keyword">private</span> String messageDelayLevel <span class="token operator">=</span> <span class="token string">"1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h"</span><span class="token punctuation">;</span>
</code></pre>
<p>现在RocketMq并不支持任意时间的延时，需要设置几个固定的延时等级，从1s到2h分别对应着等级1到18</p>
<h2 id="4-4-批量消息"><a href="#4-4-批量消息" class="headerlink" title="4.4 批量消息"></a>4.4 批量消息</h2><p>批量发送消息能显著提高传递小消息的性能。限制是这些批量消息应该有相同的topic，相同的waitStoreMsgOK，而且不能是延时消息。此外，这一批消息的总大小不应超过4MB。</p>
<h3 id="4-4-1-发送批量消息"><a href="#4-4-1-发送批量消息" class="headerlink" title="4.4.1 发送批量消息"></a>4.4.1 发送批量消息</h3><p>如果您每次只发送不超过4MB的消息，则很容易使用批处理，样例如下：</p>
<pre class=" language-java"><code class="language-java">String topic <span class="token operator">=</span> <span class="token string">"BatchTest"</span><span class="token punctuation">;</span>
List<span class="token operator">&lt;</span>Message<span class="token operator">></span> messages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
messages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> <span class="token string">"TagA"</span><span class="token punctuation">,</span> <span class="token string">"OrderID001"</span><span class="token punctuation">,</span> <span class="token string">"Hello world 0"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
messages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> <span class="token string">"TagA"</span><span class="token punctuation">,</span> <span class="token string">"OrderID002"</span><span class="token punctuation">,</span> <span class="token string">"Hello world 1"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
messages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> <span class="token string">"TagA"</span><span class="token punctuation">,</span> <span class="token string">"OrderID003"</span><span class="token punctuation">,</span> <span class="token string">"Hello world 2"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
   producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>messages<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment" spellcheck="true">//处理error</span>
<span class="token punctuation">}</span>
</code></pre>
<p>如果消息的总长度可能大于4MB时，这时候最好把消息进行分割</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ListSplitter</span> <span class="token keyword">implements</span> <span class="token class-name">Iterator</span><span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>Message<span class="token operator">>></span> <span class="token punctuation">{</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SIZE_LIMIT <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> List<span class="token operator">&lt;</span>Message<span class="token operator">></span> messages<span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">int</span> currIndex<span class="token punctuation">;</span>
   <span class="token keyword">public</span> <span class="token function">ListSplitter</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>Message<span class="token operator">></span> messages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">this</span><span class="token punctuation">.</span>messages <span class="token operator">=</span> messages<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span> 
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> currIndex <span class="token operator">&lt;</span> messages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
       <span class="token annotation punctuation">@Override</span> 
    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>Message<span class="token operator">></span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">int</span> nextIndex <span class="token operator">=</span> currIndex<span class="token punctuation">;</span>
       <span class="token keyword">int</span> totalSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
       <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> nextIndex <span class="token operator">&lt;</span> messages<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> nextIndex<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           Message message <span class="token operator">=</span> messages<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>nextIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">int</span> tmpSize <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
           Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> properties <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> entry <span class="token operator">:</span> properties<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               tmpSize <span class="token operator">+=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
           tmpSize <span class="token operator">=</span> tmpSize <span class="token operator">+</span> <span class="token number">20</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 增加日志的开销20字节</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>tmpSize <span class="token operator">></span> SIZE_LIMIT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment" spellcheck="true">//单个消息超过了最大的限制</span>
               <span class="token comment" spellcheck="true">//忽略,否则会阻塞分裂的进程</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span>nextIndex <span class="token operator">-</span> currIndex <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token comment" spellcheck="true">//假如下一个子列表没有元素,则添加这个子列表然后退出循环,否则只是退出循环</span>
                  nextIndex<span class="token operator">++</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
               <span class="token keyword">break</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>tmpSize <span class="token operator">+</span> totalSize <span class="token operator">></span> SIZE_LIMIT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">break</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
               totalSize <span class="token operator">+=</span> tmpSize<span class="token punctuation">;</span>
           <span class="token punctuation">}</span>

       <span class="token punctuation">}</span>
       List<span class="token operator">&lt;</span>Message<span class="token operator">></span> subList <span class="token operator">=</span> messages<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span>currIndex<span class="token punctuation">,</span> nextIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
       currIndex <span class="token operator">=</span> nextIndex<span class="token punctuation">;</span>
       <span class="token keyword">return</span> subList<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//把大的消息分裂成若干个小的消息</span>
ListSplitter splitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ListSplitter</span><span class="token punctuation">(</span>messages<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>splitter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      List<span class="token operator">&lt;</span>Message<span class="token operator">></span>  listItem <span class="token operator">=</span> splitter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>listItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//处理error</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="4-5-过滤消息"><a href="#4-5-过滤消息" class="headerlink" title="4.5 过滤消息"></a>4.5 过滤消息</h2><p>在大多数情况下，TAG是一个简单而有用的设计，其可以来选择您想要的消息。例如：</p>
<pre class=" language-java"><code class="language-java">DefaultMQPushConsumer consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"CID_EXAMPLE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"TOPIC"</span><span class="token punctuation">,</span> <span class="token string">"TAGA || TAGB || TAGC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>消费者将接收包含TAGA或TAGB或TAGC的消息。但是限制是一个消息只能有一个标签，这对于复杂的场景可能不起作用。在这种情况下，可以使用SQL表达式筛选消息。SQL特性可以通过发送消息时的属性来进行计算。在RocketMQ定义的语法下，可以实现一些简单的逻辑。下面是一个例子：</p>
<pre class=" language-te"><code class="language-te">------------
| message  |
|----------|  a > 5 AND b = 'abc'
| a = 10   |  --------------------> Gotten
| b = 'abc'|
| c = true |
------------
------------
| message  |
|----------|   a > 5 AND b = 'abc'
| a = 1    |  --------------------> Missed
| b = 'abc'|
| c = true |
------------
</code></pre>
<h3 id="4-5-1-SQL基本语法"><a href="#4-5-1-SQL基本语法" class="headerlink" title="4.5.1 SQL基本语法"></a>4.5.1 SQL基本语法</h3><p>RocketMQ只定义了一些基本语法来支持这个特性。你也可以很容易地扩展它。</p>
<ul>
<li>数值比较，比如：**&gt;，&gt;=，&lt;，&lt;=，BETWEEN，=；**</li>
<li>字符比较，比如：**=，&lt;&gt;，IN；**</li>
<li><strong>IS NULL</strong> 或者 <strong>IS NOT NULL；</strong></li>
<li>逻辑符号 <strong>AND，OR，NOT；</strong></li>
</ul>
<p>常量支持类型为：</p>
<ul>
<li>数值，比如：<strong>123，3.1415；</strong></li>
<li>字符，比如：**’abc’，必须用单引号包裹起来；**</li>
<li><strong>NULL</strong>，特殊的常量</li>
<li>布尔值，<strong>TRUE</strong> 或 <strong>FALSE</strong></li>
</ul>
<p>只有使用push模式的消费者才能用使用SQL92标准的sql语句，接口如下：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">subscribe</span><span class="token punctuation">(</span>finalString topic<span class="token punctuation">,</span> <span class="token keyword">final</span> MessageSelector messageSelector<span class="token punctuation">)</span>
</code></pre>
<h3 id="4-5-2-消息生产者"><a href="#4-5-2-消息生产者" class="headerlink" title="4.5.2 消息生产者"></a>4.5.2 消息生产者</h3><p>发送消息时，你能通过<code>putUserProperty</code>来设置消息的属性</p>
<pre class=" language-java"><code class="language-java">DefaultMQProducer producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"please_rename_unique_group_name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Message msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span><span class="token punctuation">,</span>
   tag<span class="token punctuation">,</span>
   <span class="token punctuation">(</span><span class="token string">"Hello RocketMQ "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>RemotingHelper<span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 设置一些属性</span>
msg<span class="token punctuation">.</span><span class="token function">putUserProperty</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
SendResult sendResult <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="4-5-3-消息消费者"><a href="#4-5-3-消息消费者" class="headerlink" title="4.5.3 消息消费者"></a>4.5.3 消息消费者</h3><p>用MessageSelector.bySql来使用sql筛选消息</p>
<pre class=" language-java"><code class="language-java">DefaultMQPushConsumer consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"please_rename_unique_group_name_4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 只有订阅的消息有这个属性a, a >=0 and a &lt;= 3</span>
consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span><span class="token punctuation">,</span> MessageSelector<span class="token punctuation">.</span><span class="token function">bySql</span><span class="token punctuation">(</span><span class="token string">"a between 0 and 3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token annotation punctuation">@Override</span>
   <span class="token keyword">public</span> ConsumeConcurrentlyStatus <span class="token function">consumeMessage</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>MessageExt<span class="token operator">></span> msgs<span class="token punctuation">,</span> ConsumeConcurrentlyContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> ConsumeConcurrentlyStatus<span class="token punctuation">.</span>CONSUME_SUCCESS<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="4-6-事务消息"><a href="#4-6-事务消息" class="headerlink" title="4.6 事务消息"></a>4.6 事务消息</h2><p>###4.6.1 流程分析</p>
<p><img src="/2021/06/04/RocketMQ-1/%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF.png" alt="事务消息.png"></p>
<p>上图说明了事务消息的大致方案，其中分为两个流程：正常事务消息的发送及提交、事务消息的补偿流程。</p>
<p>####1）事务消息发送及提交</p>
<p>(1) 发送消息（half消息）。</p>
<p>(2) 服务端响应消息写入结果。</p>
<p>(3) 根据发送结果执行本地事务（如果写入失败，此时half消息对业务不可见，本地逻辑不执行）。</p>
<p>(4) 根据本地事务状态执行Commit或者Rollback（Commit操作生成消息索引，消息对消费者可见）</p>
<h4 id="2）事务补偿"><a href="#2）事务补偿" class="headerlink" title="2）事务补偿"></a>2）事务补偿</h4><p>(1) 对没有Commit/Rollback的事务消息（pending状态的消息），从服务端发起一次“回查”</p>
<p>(2) Producer收到回查消息，检查回查消息对应的本地事务的状态</p>
<p>(3) 根据本地事务状态，重新Commit或者Rollback</p>
<p>其中，补偿阶段用于解决消息Commit或者Rollback发生超时或者失败的情况。</p>
<h4 id="3）事务消息状态"><a href="#3）事务消息状态" class="headerlink" title="3）事务消息状态"></a>3）事务消息状态</h4><p>事务消息共有三种状态，提交状态、回滚状态、中间状态：</p>
<ul>
<li>TransactionStatus.CommitTransaction: 提交事务，它允许消费者消费此消息。</li>
<li>TransactionStatus.RollbackTransaction: 回滚事务，它代表该消息将被删除，不允许被消费。</li>
<li>TransactionStatus.Unknown: 中间状态，它代表需要检查消息队列来确定状态。</li>
</ul>
<p>###4.6.1 发送事务消息</p>
<h4 id="1-创建事务性生产者"><a href="#1-创建事务性生产者" class="headerlink" title="1) 创建事务性生产者"></a>1) 创建事务性生产者</h4><p>使用 <code>TransactionMQProducer</code>类创建生产者，并指定唯一的 <code>ProducerGroup</code>，就可以设置自定义线程池来处理这些检查请求。执行本地事务后、需要根据执行结果对消息队列进行回复。回传的事务状态在请参考前一节。</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> MQClientException<span class="token punctuation">,</span> InterruptedException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//创建事务监听器</span>
        TransactionListener transactionListener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionListenerImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//创建消息生产者</span>
        TransactionMQProducer producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionMQProducer</span><span class="token punctuation">(</span><span class="token string">"group6"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">setNamesrvAddr</span><span class="token punctuation">(</span><span class="token string">"192.168.25.135:9876;192.168.25.138:9876"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//生产者这是监听器</span>
        producer<span class="token punctuation">.</span><span class="token function">setTransactionListener</span><span class="token punctuation">(</span>transactionListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//启动消息生产者</span>
        producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> tags <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"TagA"</span><span class="token punctuation">,</span> <span class="token string">"TagB"</span><span class="token punctuation">,</span> <span class="token string">"TagC"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                Message msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"TransactionTopic"</span><span class="token punctuation">,</span> tags<span class="token punctuation">[</span>i <span class="token operator">%</span> tags<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"KEY"</span> <span class="token operator">+</span> i<span class="token punctuation">,</span>
                        <span class="token punctuation">(</span><span class="token string">"Hello RocketMQ "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>RemotingHelper<span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                SendResult sendResult <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">sendMessageInTransaction</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s%n"</span><span class="token punctuation">,</span> sendResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
                TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MQClientException</span> <span class="token operator">|</span> UnsupportedEncodingException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//producer.shutdown();</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="2）实现事务的监听接口"><a href="#2）实现事务的监听接口" class="headerlink" title="2）实现事务的监听接口"></a>2）实现事务的监听接口</h4><p>当发送半消息成功时，我们使用 <code>executeLocalTransaction</code> 方法来执行本地事务。它返回前一节中提到的三个事务状态之一。<code>checkLocalTranscation</code> 方法用于检查本地事务状态，并回应消息队列的检查请求。它也是返回前一节中提到的三个事务状态之一。</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionListenerImpl</span> <span class="token keyword">implements</span> <span class="token class-name">TransactionListener</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> LocalTransactionState <span class="token function">executeLocalTransaction</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">,</span> Object arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"执行本地事务"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"TagA"</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> LocalTransactionState<span class="token punctuation">.</span>COMMIT_MESSAGE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"TagB"</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> LocalTransactionState<span class="token punctuation">.</span>ROLLBACK_MESSAGE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> LocalTransactionState<span class="token punctuation">.</span>UNKNOW<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> LocalTransactionState <span class="token function">checkLocalTransaction</span><span class="token punctuation">(</span>MessageExt msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"MQ检查消息Tag【"</span><span class="token operator">+</span>msg<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"】的本地事务执行结果"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> LocalTransactionState<span class="token punctuation">.</span>COMMIT_MESSAGE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="4-6-2-使用限制"><a href="#4-6-2-使用限制" class="headerlink" title="4.6.2 使用限制"></a>4.6.2 使用限制</h3><ol>
<li>事务消息不支持延时消息和批量消息。</li>
<li>为了避免单个消息被检查太多次而导致半队列消息累积，我们默认将单个消息的检查次数限制为 15 次，但是用户可以通过 Broker 配置文件的 <code>transactionCheckMax</code>参数来修改此限制。如果已经检查某条消息超过 N 次的话（ N = <code>transactionCheckMax</code> ） 则 Broker 将丢弃此消息，并在默认情况下同时打印错误日志。用户可以通过重写 <code>AbstractTransactionCheckListener</code> 类来修改这个行为。</li>
<li>事务消息将在 Broker 配置文件中的参数 transactionMsgTimeout 这样的特定时间长度之后被检查。当发送事务消息时，用户还可以通过设置用户属性 CHECK_IMMUNITY_TIME_IN_SECONDS 来改变这个限制，该参数优先于 <code>transactionMsgTimeout</code> 参数。</li>
<li>事务性消息可能不止一次被检查或消费。</li>
<li>提交给用户的目标主题消息可能会失败，目前这依日志的记录而定。它的高可用性通过 RocketMQ 本身的高可用性机制来保证，如果希望确保事务消息不丢失、并且事务完整性得到保证，建议使用同步的双重写入机制。</li>
<li>事务消息的生产者 ID 不能与其他类型消息的生产者 ID 共享。与其他类型的消息不同，事务消息允许反向查询、MQ服务器能通过它们的生产者 ID 查询到消费者。</li>
</ol>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Siri Zhang</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://zyunti0033.github.io/2021/06/04/RocketMQ-1/">https://zyunti0033.github.io/2021/06/04/RocketMQ-1/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">Siri Zhang</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/">
                                    <span class="chip bg-color">消息中间件</span>
                                </a>
                            
                                <a href="/tags/RocketMQ/">
                                    <span class="chip bg-color">RocketMQ</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/libs/valine/av-min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: '3MgHRr9EOeN7iV8wMxL19hWb-gzGzoHsz',
        appKey: 'RMU9ybmBejdY3G4sHAaOVvVj',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '想说点什么吗？'
    });
</script>

<!--酷Q推送-->


    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/06/04/RocketMQ-2/">
                    <div class="card-image">
                        
                        <img src="https://ucc.alicdn.com/pic/developer-ecology/8a4242c472dd4f669ff5ad3d4095468e.jpg" class="responsive-img" alt="RocketMQ-2">
                        
                        <span class="card-title">RocketMQ-2</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-06-04
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/JAVA/" class="post-category">
                                    JAVA
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/">
                        <span class="chip bg-color">消息中间件</span>
                    </a>
                    
                    <a href="/tags/RocketMQ/">
                        <span class="chip bg-color">RocketMQ</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/06/03/hello-world/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/medias/featureimages/12.jpg" class="responsive-img" alt="Hello World">
                        
                        <span class="card-title">Hello World</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-06-03
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/essays/" class="post-category">
                                    essays
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2021</span>
            
            <span id="year">2021</span>
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">46k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>
	<!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2021";
                        var startMonth = "6";
                        var startDate = "3";
                        var startHour = "24";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);
                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }
                    calcSiteTime();
                </script>
            
	<br>
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/zyunti0033" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:15735468520@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2679778174" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2679778174" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.5'
        zIndex="-1" count="200"
        src="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/libs/background/canvas-nest.js"></script>
    

    

    

    
    <script src="https://cdn.jsdelivr.net/gh/skyls03/skyls03.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

<script>(function (w, d, s, id) {
            if (typeof (w.webpushr) !== 'undefined') return; w.webpushr = w.webpushr || function () { (w.webpushr.q = w.webpushr.q || []).push(arguments) }; var js, fjs = d.getElementsByTagName(s)[0]; js = d.createElement(s); js.id = id; js.async = 1; js.src = "https://cdn.webpushr.com/app.min.js";fjs.parentNode.appendChild(js);}(window, document, 'script', 'webpushr-jssdk'));webpushr('setup', { 'key': 'AEGlpbdgvBCWXqXI6PtsUzobY7TLV9gwJU8bzMktrwfrSERg_xnLVbjpCw8x2GmFmi1ZcLTz0ni6OnX5MAwoM88' });</script></body>

</html>
